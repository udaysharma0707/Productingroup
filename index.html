<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Ã¢Å“â€¦ html2canvas for image generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ ADD THIS LINE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    .table-explorer { background:#fff; border-radius:6px; overflow:hidden; }
    .file-icon { font-size:1.15rem; display:inline-block; width:1.6rem; text-align:center; }
    .stock-badge{font-size:.85rem;padding:.25rem .5rem;border-radius:.5rem}
    .mobile-list{display:none}
    .mobile-item{background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.7rem;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .btn-action-sm{padding:.25rem .5rem;font-size:.85rem}
    .sync-indicator{position:fixed;top:70px;left:20px;background:#fff;padding:8px 12px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:none;z-index:1000}
   /* Sales grid mobile transforms */
@media (max-width:768px) {
  .desktop-table { display:none !important; }
  .mobile-list { display:block !important; }
  /* Make table rows card-like */
  .grid-table thead { display:none; }
  .grid-table tbody tr { display:block; margin-bottom:12px; padding:12px; border:1px solid #e9ecef; border-radius:8px; background:#fff; }
  .grid-table td { display:block; width:100%; padding:.35rem 0; border:0; }
  .grid-row-number { float:right; font-size:.85rem; color:#6c757d; }
  .product-select, .qty-input, .price-input { width:100% !important; font-size:16px; height:44px; }
  .mobile-two-col { display:flex; gap:10px; }
  .mobile-two-col > div { flex:1; }
  .modal-dialog { margin:.5rem; max-width: calc(100% - 1rem); }
  .modal-body { max-height: calc(100vh - 200px); overflow-y:auto; -webkit-overflow-scrolling: touch; }
  .modal-footer { position: sticky; bottom:0; background: white; z-index:10; box-shadow:0 -2px 10px rgba(0,0,0,.08); }
}
/* Hide top bar (header) on full-screen pages */
.page-view.active ~ header,
.page-view.active ~ .top-bar {
  display: none !important;
}

/* OR if you want to hide it within the page view itself */
.page-view {
  padding-top: 0 !important;
}

/* Make sure the blue box (action buttons) only shows on homepage */
#mainApp .action-buttons {
  /* Your existing styles */
}

/* Hide action buttons when NOT on home */
.page-view.active ~ #mainApp .action-buttons,
body:has(.page-view.active) .action-buttons {
  display: none !important;
}

/* ==========================================
   FULL-SCREEN PAGE VIEW SYSTEM
   ========================================== */

/* Hide all page views by default */
.page-view {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: #f8f9fa;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

/* Show active page */
.page-view.active {
  display: block;
}

/* Page header with back button */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-header h3 {
  margin: 0;
  flex: 1;
  text-align: center;
}

/* Back button */
.back-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
}

.back-btn:hover {
  background: #0056b3;
}

/* Product list compact view */
.product-list-compact {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.product-item-compact {
  display: flex;
  align-items: center;
  gap: 12px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.product-item-icon {
  font-size: 32px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f0f0f0;
  border-radius: 8px;
}

.product-item-info {
  flex: 1;
}

.product-item-name {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 5px;
  color: #333;
}

.product-item-details {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 13px;
  color: #666;
}

.product-item-actions {
  display: flex;
  gap: 8px;
}

.btn-edit-compact,
.btn-delete-compact {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.btn-edit-compact {
  background: #007bff;
  color: white;
}

.btn-delete-compact {
  background: #dc3545;
  color: white;
}

/* Group cards */
.group-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin-bottom: 15px;
  cursor: pointer;
  transition: transform 0.2s;
}

.group-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.group-card-header {
  display: flex;
  align-items: center;
  gap: 15px;
}

.group-card-icon {
  font-size: 32px;
  color: #007bff;
}

.group-card-title h4 {
  margin: 0;
  font-size: 18px;
  color: #333;
}

.group-card-title p {
  margin: 5px 0 0 0;
  font-size: 13px;
  color: #999;
}

.group-card-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
}




    
/* ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Additional mobile fixes for Record Sale modal */
@media (max-width: 768px) {
    /* Specific fixes for salesModal only */
    #salesModal .modal-dialog {
        margin: 0.25rem;
        max-width: calc(100% - 0.5rem);
    }
    
    #salesModal .modal-body {
        padding: 0.75rem 0.5rem;
    }
    
    /* Smaller font for sales grid on mobile */
    #salesModal .grid-table {
        font-size: 0.85rem;
    }
    
    /* Add labels before each field for clarity */
    #salesModal .grid-table td:nth-child(2)::before { 
        content: "Product: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(3)::before { 
        content: "Size: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(4)::before { 
        content: "Qty: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(5)::before { 
        content: "Unit: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(6)::before { 
        content: "Price: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(7)::before { 
        content: "Total: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    /* Hide row number on mobile */
    #salesModal .grid-table td:nth-child(1) {
        display: none;
    }
    
    /* Make total more prominent */
    #salesModal .grid-table td:nth-child(7) {
        font-size: 1.1rem;
        color: #28a745;
        font-weight: bold;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 2px solid #28a745;
    }
    
    /* Ensure inputs are touch-friendly */
    #salesModal .product-select,
    #salesModal .qty-input {
        width: 100% !important;
        font-size: 16px !important;
        height: 44px;
        margin-top: 4px;
    }
    
    /* Multi-select dropdown smaller on mobile */
    .multi-select-options {
        max-height: 200px;
    }
    
    /* Stack modal footer buttons vertically */
    #salesModal .modal-footer {
        flex-direction: column;
        gap: 8px;
    }
    
    #salesModal .modal-footer button {
        width: 100%;
        margin: 0;
    }
    
    /* Smaller buttons on mobile */
    #salesModal .btn-sm {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }
}

    
/* ==========================================
   SUCCESS TOAST NOTIFICATION
   ========================================== */

.toast-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-left: 4px solid #28a745;
  z-index: 10000;
  opacity: 0;
  transform: translateX(400px);
  transition: all 0.3s ease;
  max-width: 350px;
}

.toast-notification.show {
  opacity: 1;
  transform: translateX(0);
}

/* ===== PHOTO PRODUCT STYLES ===== */
.upload-area {
  border: 3px dashed #2196F3;
  border-radius: 15px;
  padding: 30px 20px;
  margin: 20px 0;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f8f9ff;
  text-align: center;
}

.upload-area:hover {
  border-color: #1976D2;
  background: #e3f2fd;
}

.upload-icon {
  font-size: 3rem;
  color: #2196F3;
  margin-bottom: 10px;
}

.upload-text {
  color: #666;
  font-size: 1rem;
  margin-bottom: 15px;
}

.preview-container {
  margin: 20px 0;
  display: none;
  text-align: center;
}

.preview-image {
  max-width: 100%;
  max-height: 250px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  margin-bottom: 15px;
}

#photoProductGrid .card {
  transition: transform 0.2s, box-shadow 0.2s;
}

#photoProductGrid .card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
}

#photoProductGrid .card-img-top {
  cursor: pointer;
  transition: transform 0.3s;
}

#photoProductGrid .card-img-top:hover {
  transform: scale(1.05);
}

.photo-thumbnail-small {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 4px;
  border: 2px solid #e0e0e0;
  margin-right: 8px;
}

.loading-spinner {
  display: none;
  text-align: center;
  margin: 20px 0;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #2196F3;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}




    
/* Background sync indicator (optional) */
#backgroundSyncStatus {
  display: none;
  font-size: 0.85rem;
  color: #6c757d;
  padding: 0.25rem 0.75rem;
  background: rgba(13, 110, 253, 0.1);
  border-radius: 20px;
}

#backgroundSyncStatus i {
  color: #0d6efd;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}




    
/* ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Mobile Recent Sales Table Optimization */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.75rem;
        overflow-x: auto;
    }
    
    #salesList td {
        padding: 0.4rem 0.2rem !important;
        font-size: 0.75rem;
    }
    
    #salesList th {
        padding: 0.5rem 0.2rem !important;
        font-size: 0.8rem;
    }
    
    #salesList td:nth-child(1),
    #salesList th:nth-child(1) {
        max-width: 85px;
        word-wrap: break-word;
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    #salesList td:nth-child(2),
    #salesList th:nth-child(2) {
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #salesList td:nth-child(3),
    #salesList th:nth-child(3) {
        text-align: center;
        max-width: 45px;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(4),
    #salesList th:nth-child(4) {
        text-align: center;
        max-width: 45px;
        font-size: 0.7rem;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(5) {
        font-weight: bold;
        color: #28a745;
        font-size: 0.85rem;
        text-align: right;
        max-width: 80px;
    }
    
    #salesList th:nth-child(5) {
        text-align: right;
        max-width: 80px;
    }
}


    /* Multi-Select Dropdown Styles */
.multi-select-dropdown {
    position: relative;
}

.multi-select-toggle {
    cursor: pointer;
}

.multi-select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    padding: 10px;
    display: none;
}

.multi-select-options.show {
    display: block;
}

.multi-select-list {
    max-height: 250px;
    overflow-y: auto;
}

.multi-select-item {
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 4px;
}

.multi-select-item:hover {
    background-color: #f8f9fa;
}

.multi-select-item label {
    cursor: pointer;
    margin-bottom: 0;
    width: 100%;
}

/* ==========================================
   SIDEBAR MENU (Zoho-style)
   ========================================== */

/* Sidebar Container */
.sidebar-menu {
  position: fixed;
  left: -280px;
  top: 0;
  width: 280px;
  height: 100vh;
  background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
  box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
  z-index: 1001;
  transition: left 0.3s ease;
  overflow-y: auto;
}

.sidebar-menu.open {
  left: 0;
}

/* Sidebar Header */
.sidebar-header {
  padding: 25px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  text-align: center;
  color: white;
}

.sidebar-header h4 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

/* Menu Section Title */
.sidebar-section-title {
  padding: 15px 20px 8px 20px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.5);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Menu Items */
.sidebar-item {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
}

.sidebar-item:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.sidebar-item i {
  font-size: 18px;
  margin-right: 15px;
  width: 20px;
  text-align: center;
}

.sidebar-item span {
  font-size: 14px;
  font-weight: 500;
}

.sidebar-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.sidebar-item.disabled:hover {
  background: transparent;
}

/* Hamburger Menu Button */
.sidebar-toggle-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  z-index: 1002;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  transition: all 0.3s ease;
}

.sidebar-toggle-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

/* Overlay */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sidebar-overlay.show {
  display: block;
  opacity: 1;
}

/* Scrollbar for sidebar */
.sidebar-menu::-webkit-scrollbar {
  width: 6px;
}

.sidebar-menu::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

.sidebar-menu::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
}

.sidebar-menu::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}
/* ==========================================
   ALL PRODUCTS PAGE & PRODUCT GROUPS
   ========================================== */

/* Page Container */
.page-view {
  display: none;
  padding: 20px;
  min-height: 100vh;
}

.page-view.active {
  display: block;
}

/* Page Header */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.page-header h3 {
  margin: 0;
  font-size: 22px;
  color: #333;
}

.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
}

.back-btn:hover {
  background: #5a6268;
}

/* Product List (Compact Mobile View) */
.product-list-compact {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.product-item-compact {
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.2s ease;
}

.product-item-compact:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.product-item-icon {
  width: 40px;
  height: 40px;
  background: #f8f9fa;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
}

.product-item-info {
  flex: 1;
  min-width: 0;
}

.product-item-name {
  font-weight: 600;
  font-size: 15px;
  color: #333;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.product-item-details {
  font-size: 12px;
  color: #666;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.product-item-details span {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.product-item-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

.product-item-actions button {
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-view {
  background: #0d6efd;
  color: white;
}

.btn-view:hover {
  background: #0b5ed7;
}

.btn-edit-compact {
  background: #28a745;
  color: white;
}

.btn-edit-compact:hover {
  background: #218838;
}

.btn-delete-compact {
  background: #dc3545;
  color: white;
}

.btn-delete-compact:hover {
  background: #c82333;
}

/* Group Card */
.group-card {
  background: white;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.group-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.group-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.group-card-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
}

.group-card-title {
  flex: 1;
}

.group-card-title h4 {
  margin: 0 0 4px 0;
  font-size: 18px;
  color: #333;
}

.group-card-title p {
  margin: 0;
  font-size: 13px;
  color: #666;
}

.group-card-actions {
  display: flex;
  gap: 6px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #eee;
}

.group-card-actions button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

/* Floating Add Button */
.floating-add-btn {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  cursor: pointer;
  z-index: 999;
  transition: all 0.3s ease;
}

.floating-add-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .page-view {
    padding: 15px 10px;
  }
  
  .page-header h3 {
    font-size: 18px;
  }
  
  .product-item-actions button {
    padding: 5px 8px;
    font-size: 12px;
  }
}

  /**
 * ==========================================
 * PRODUCT GROUPS - MOBILE-FIRST STYLES
 * ==========================================
 */

/* Full-screen modal for mobile */
.fullscreen-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: #ffffff;
  z-index: 99999;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.fullscreen-modal.active {
  display: block;
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

/* Mobile header with back button */
.modal-header-mobile {
  position: sticky;
  top: 0;
  background: #ffffff;
  padding: 12px 16px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.modal-header-mobile h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1a1a1a;
  flex: 1;
  text-align: center;
}

.btn-cancel-modal {
  background: transparent;
  color: #dc3545;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Mobile form styles */
.mobile-form {
  padding: 16px;
  padding-bottom: 100px; /* Space for fixed bottom buttons */
}

.form-section {
  margin-bottom: 24px;
  background: #f8f9fa;
  padding: 16px;
  border-radius: 12px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 8px 0;
}

.section-description {
  font-size: 13px;
  color: #666;
  margin: 0 0 16px 0;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
  margin-top: 16px;
}

.form-label:first-child {
  margin-top: 0;
}

.form-label .required {
  color: #dc3545;
  margin-left: 2px;
}

/* Mobile-optimized inputs */
input[type="text"],
input[type="number"],
input[type="email"],
textarea,
select {
  width: 100%;
  padding: 14px;
  font-size: 16px; /* Prevents zoom on iOS */
  border: 1px solid #ddd;
  border-radius: 8px;
  background: white;
  min-height: 48px;
  box-sizing: border-box;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-family: inherit;
}

input[type="text"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 1.5;
}

select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

/* Attribute row card */
.attribute-row {
  background: white;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 16px;
  border: 2px solid #e0e0e0;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.attribute-row.highlight {
  border-color: #007bff;
  background: #f0f7ff;
}

.attribute-row-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.attribute-row-title {
  font-size: 14px;
  font-weight: 600;
  color: #666;
}

.btn-remove-attr {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  min-height: 32px;
}

.btn-remove-attr:active {
  background: #bd2130;
}

/* Add more button */
.btn-add-more {
  width: 100%;
  padding: 14px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 48px;
}

.btn-add-more:active {
  background: #0056b3;
}

/* Variant preview */
.variant-preview-section {
  background: white;
  padding: 16px;
  border-radius: 12px;
  border: 2px solid #e3f2fd;
}

.variant-count-badge {
  display: inline-block;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
}

.variant-preview-list {
  max-height: 250px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.variant-preview-item {
  padding: 10px 12px;
  background: #e3f2fd;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
  color: #1976d2;
  display: flex;
  align-items: center;
  gap: 8px;
}

.variant-preview-item:last-child {
  margin-bottom: 0;
}

.variant-preview-item .icon {
  font-size: 16px;
}

.variant-preview-more {
  padding: 10px 12px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
  font-size: 13px;
  color: #666;
  font-style: italic;
}

/* Fixed bottom action buttons */
.form-actions-bottom {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px 16px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  display: flex;
  gap: 12px;
  z-index: 1000;
}

.btn-secondary-bottom {
  flex: 1;
  padding: 14px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 48px;
}

.btn-secondary-bottom:active {
  background: #5a6268;
}

.btn-primary-bottom {
  flex: 2;
  padding: 14px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary-bottom:active {
  background: #218838;
}

.btn-primary-bottom:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* Group card in list */
.group-card {
  background: white;
  margin: 0 16px 12px 16px;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex;
  gap: 12px;
  align-items: center;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.group-card:active {
  transform: scale(0.98);
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}

.group-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  flex-shrink: 0;
}

.group-info {
  flex: 1;
  min-width: 0;
}

.group-name {
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.group-description {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.group-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 12px;
}

.group-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
  color: #999;
  background: #f5f5f5;
  padding: 4px 8px;
  border-radius: 4px;
}

.group-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex-shrink: 0;
}

.btn-icon-small {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.btn-icon-small:active {
  transform: scale(0.95);
}

.btn-edit-small {
  background: #007bff;
  color: white;
}

.btn-delete-small {
  background: #dc3545;
  color: white;
}

/* Variant card */
.variant-card {
  background: white;
  margin: 0 16px 12px 16px;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex;
  gap: 12px;
  align-items: center;
}

.variant-icon {
  width: 56px;
  height: 56px;
  background: #f0f0f0;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}

.variant-info {
  flex: 1;
  min-width: 0;
}

.variant-name {
  font-size: 15px;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.variant-attributes {
  font-size: 13px;
  color: #666;
  margin-bottom: 6px;
}

.variant-details {
  display: flex;
  gap: 12px;
  font-size: 13px;
}

.variant-stock {
  display: flex;
  align-items: center;
  gap: 4px;
}

.variant-stock.low {
  color: #dc3545;
  font-weight: 600;
}

.variant-stock.good {
  color: #28a745;
  font-weight: 600;
}

.variant-price {
  color: #007bff;
  font-weight: 600;
}

.variant-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

/* Loading spinner */
.loading-spinner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: #666;
}

.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Empty state */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  color: #999;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 18px;
  color: #666;
  margin: 0 0 8px 0;
}

.empty-state p {
  font-size: 14px;
  color: #999;
  margin: 0 0 24px 0;
}

/* Success message overlay */
.success-overlay {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(40, 167, 69, 0.95);
  color: white;
  padding: 20px 32px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  z-index: 100000;
  display: none;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.success-overlay.show {
  display: block;
  animation: successPop 0.3s ease-out;
}

@keyframes successPop {
  0% {
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}

/* Responsive adjustments */
@media (min-width: 768px) {
  .group-card {
    margin: 0 auto 12px auto;
    max-width: 600px;
  }
  
  .variant-card {
    margin: 0 auto 12px auto;
    max-width: 600px;
  }
  
  .mobile-form {
    max-width: 600px;
    margin: 0 auto;
  }
}

/* iOS specific fixes */
@supports (-webkit-touch-callout: none) {
  input[type="text"],
  input[type="number"],
  textarea,
  select {
    font-size: 16px; /* Prevent zoom on focus */
  }
}

/* Hide navbar on fullscreen modals */
body:has(.fullscreen-modal.active) .navbar {
  display: none !important;
}



    
  </style>
</head>
<body>

<!-- ==========================================
     SIDEBAR MENU (Zoho-style)
     ========================================== -->

<!-- Hamburger Menu Button -->
<button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
  <i class="bi bi-list"></i>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar Menu -->
<nav class="sidebar-menu" id="sidebarMenu">
  
  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <i class="bi bi-boxes" style="font-size: 32px;"></i>
    <h4>Menu</h4>
  </div>
  
  <!-- Home -->
  <div class="sidebar-item" onclick="goToHome()">
    <i class="bi bi-house-door"></i>
    <span>Home</span>
  </div>
  
  <!-- GENERAL Section -->
  <div class="sidebar-section-title">GENERAL</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('addUsers')">
    <i class="bi bi-person-plus"></i>
    <span>Add Users</span>
  </div>
  
// NEW (with safety check):
<div class="sidebar-item" onclick="if(typeof navigateToAllProducts === 'function') navigateToAllProducts()">
  <i class="bi bi-box"></i>
  <span>All Products</span>
</div>

<div class="sidebar-item" onclick="if(typeof navigateToProductGroups === 'function') navigateToProductGroups()">
  <i class="bi bi-collection"></i>
  <span>Products in Group</span>
</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('inventoryAdjustments')">
    <i class="bi bi-sliders"></i>
    <span>Inventory Adjustments</span>
  </div>
  
  <!-- SALES Section -->
  <div class="sidebar-section-title">SALES</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('customer')">
    <i class="bi bi-person"></i>
    <span>Customer</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('invoices')">
    <i class="bi bi-receipt"></i>
    <span>Invoices</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('salesReceipts')">
    <i class="bi bi-cash-stack"></i>
    <span>Sales Receipts</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('salesOrder')">
    <i class="bi bi-cart-check"></i>
    <span>Sales Order</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('packages')">
    <i class="bi bi-box-seam"></i>
    <span>Packages</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('shipment')">
    <i class="bi bi-truck"></i>
    <span>Shipment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('customerPayment')">
    <i class="bi bi-credit-card"></i>
    <span>Customer Payment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('creditNotes')">
    <i class="bi bi-file-text"></i>
    <span>Credit Notes</span>
  </div>
  
  <!-- PURCHASES Section -->
  <div class="sidebar-section-title">PURCHASES</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendor')">
    <i class="bi bi-building"></i>
    <span>Vendor</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('expenses')">
    <i class="bi bi-cash-coin"></i>
    <span>Expenses</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('bills')">
    <i class="bi bi-file-earmark-text"></i>
    <span>Bills</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('purchaseOrders')">
    <i class="bi bi-bag-check"></i>
    <span>Purchase Orders</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('purchaseReceives')">
    <i class="bi bi-inbox"></i>
    <span>Purchase Receives</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendorPayment')">
    <i class="bi bi-wallet2"></i>
    <span>Vendor Payment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendorCredits')">
    <i class="bi bi-arrow-left-circle"></i>
    <span>Vendor Credits</span>
  </div>
  
  <!-- Settings -->
  <div class="sidebar-section-title">SYSTEM</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('settings')">
    <i class="bi bi-gear"></i>
    <span>Settings</span>
  </div>
  
</nav>


<div id="authScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999;">
  <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg" style="max-width: 420px; width: 100%; border-radius: 15px;">
      <div class="card-body text-center p-5">
        <div class="mb-4">
          <i class="bi bi-building" style="font-size: 4rem; color: #0d6efd;"></i>
        </div>
        <h2 class="mb-3">Tile & Sanitaryware Inventory</h2>
        <p class="text-muted mb-4">Sign in to access inventory</p>
        
        <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Email + Password Form -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Email address" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>
          
          <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Password Input with Toggle -->
          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>
          
          <button type="submit" id="loginButton" class="btn btn-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
          </button>
        </form>
        
        <div class="text-muted mt-4" style="font-size: 0.875rem;">
          <i class="bi bi-lock-fill me-1"></i> Secure access with password
        </div>
      </div>
    </div>
  </div>
</div>




<!-- App Content (hidden until authenticated) -->
<div id="appContent" style="display:none;">

  <!-- YOUR EXISTING NAVBAR, DASHBOARD, ETC. GOES HERE -->

  
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()"><i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
        <div class="d-flex align-items-center">
  <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
  <span id="userName" class="me-3">User</span>

  <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Background sync indicator -->
  <div id="backgroundSyncStatus">
    <i class="bi bi-cloud-upload-fill"></i>
    <span>Syncing</span>
  </div>


          
  <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Change Password Button -->
  <button class="btn btn-outline-light btn-sm me-2" onclick="openChangePasswordModal()">
    <i class="bi bi-key me-1"></i>Change Password
  </button>
  
  <button class="btn btn-outline-light btn-sm" onclick="signOut()">
    <i class="bi bi-box-arrow-right me-1"></i>Sign Out
  </button>
</div>



        <!-- ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: View Invoices Button -->
      <button class="btn btn-success btn-sm" onclick="viewSavedInvoices()">
        <i class="bi bi-receipt-cutoff"></i> View Invoices
      </button>
    </div>
  </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Actions -->
    <div class="row mb-4">
      <div class="text-center my-3">
  <button class="btn btn-success me-2" onclick="showAddProduct()">
    <i class="bi bi-plus-circle"></i> Add Product
  </button>
  
  <!-- Ã¢Å“â€¦ NEW: Photo Product Button -->
  <button class="btn btn-primary me-2" onclick="openPhotoProductModal()">
    <i class="bi bi-camera"></i> Product by Photo
  </button>
  
  <button class="btn btn-info" onclick="openSalesModal()">
    <i class="bi bi-cart"></i> Record Sale
  </button>
</div>


    <!-- Summary - Updated with 4 Boxes -->
<div class="row mb-4">
  
  <!-- 1. Total Products -->
  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <i class="bi bi-box-seam text-primary" style="font-size:2rem"></i>
        <h3 id="totalProducts" class="mt-2">0</h3>
        <p class="text-muted mb-0">Total Products</p>
      </div>
    </div>
  </div>
  
  <!-- 2. Products in Group (New - Display Only) -->
  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <i class="bi bi-collection text-info" style="font-size:2rem"></i>
        <h3 id="productsInGroup" class="mt-2">0</h3>
        <p class="text-muted mb-0">Products in Group</p>
      </div>
    </div>
  </div>
  
  <!-- 3. Low Stock Items -->
  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i>
        <h3 id="lowStock" class="mt-2">0</h3>
        <p class="text-muted mb-0">Low Stock Items</p>
      </div>
    </div>
  </div>
  
  <!-- 4. Inventory Summary (New - Display Only) -->
  <div class="col-md-3 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-center mb-3">
          <i class="bi bi-layers text-success" style="font-size:2rem"></i>
          <p class="text-muted mb-0 mt-2"><strong>Inventory Summary</strong></p>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
          <span class="text-muted small">Quantity in Hand</span>
          <span class="fw-bold" id="quantityInHand">0</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">To be Received</span>
          <span class="fw-bold" id="quantityToBeReceived">0</span>
        </div>
      </div>
    </div>
  </div>
  
</div>


    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <!-- Search bar with view toggle -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <input type="text" id="productSearch" class="form-control" placeholder="Ã°Å¸â€Å½ Search products..." onkeyup="searchProducts()">
  
  <!-- Ã¢Å“â€¦ NEW: View Mode Toggle -->
  <div class="btn-group ms-3" role="group">
    <button type="button" class="btn btn-outline-secondary btn-sm active" id="btnAllView" onclick="showAllProducts()">
      <i class="bi bi-list"></i> All
    </button>
    <button type="button" class="btn btn-outline-primary btn-sm" id="btnPhotoView" onclick="showPhotoProducts()">
      <i class="bi bi-images"></i> Photos
    </button>
  </div>
</div>

<!-- Ã¢Å“â€¦ NEW: Photo Product Grid (Hidden by default) -->
<div id="photoProductGrid" style="display:none;" class="row row-cols-1 row-cols-md-3 g-4 mb-4">
  <!-- Photo product cards will be dynamically inserted here -->
</div>

      </div>
    </div>

    <!-- Products table (desktop) & mobile list -->
    <div class="row mb-4">
      <div class="col-12 desktop-table">
        <div class="table-explorer">
          <table class="table table-sm table-striped mb-0">
            <thead><tr><th style="width:50px">Icon</th><th>Photo</th><th>Product</th><th>Category</th><th>Brand</th><th>Size</th><th style="width:120px">Stock</th><th style="width:140px">Price</th><th style="width:150px">Actions</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
    </div>

  <!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Recent Sales</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="openClearSalesPopup()">
                <i class="bi bi-trash"></i> Clear Sales
            </button>
        </div>
        <div class="table-responsive">

          <table class="table table-striped">
            <thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<!-- âœ… NEW: All Products Page -->
<div class="page-view" id="allProductsPage">
  <div class="page-header">
    <button class="back-btn" onclick="navigateToHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3>All Products</h3>
    <button class="btn btn-success" onclick="openAddProduct()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Bar -->
  <div class="mb-3">
    <input type="text" 
           class="form-control" 
           id="allProductsSearch" 
           placeholder="ðŸ” Search products by name, category, brand..." 
           onkeyup="filterAllProducts()">
  </div>
  
  <!-- Filter Buttons -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('all')">All</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Tiles')">Tiles</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Sanitaryware')">Sanitaryware</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Accessories')">Accessories</button>
  </div>
  
  <!-- Products List -->
  <div class="product-list-compact" id="allProductsList">
    <!-- Products will be rendered here -->
  </div>
</div>

<!-- âœ… NEW: Product Groups Page -->
<div class="page-view" id="productGroupsPage">
  <div class="page-header">
    <button class="back-btn" onclick="navigateToHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3>Products in Group</h3>
    <button class="btn btn-success" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create
    </button>
  </div>
  
  <!-- Groups List -->
  <div id="productGroupsList">
    <!-- Groups will be rendered here -->
  </div>
  
  <!-- Empty State -->
  <div id="groupsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
    <i class="bi bi-collection" style="font-size:64px; color:#ccc;"></i>
    <h4 style="margin-top:20px; color:#666;">No Product Groups Yet</h4>
    <p style="color:#999;">Create your first product group to manage variants</p>
    <button class="btn btn-primary mt-3" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create First Group
    </button>
  </div>
</div>

<!-- âœ… NEW: Group Detail Page (Variants List) -->
<div class="page-view" id="groupDetailPage">
  <div class="page-header">
    <button class="back-btn" onclick="navigateToProductGroups()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3 id="groupDetailTitle">Group Name</h3>
  </div>
  
  <!-- Search Bar -->
  <div class="mb-3">
    <input type="text" 
           class="form-control" 
           id="groupVariantsSearch" 
           placeholder="ðŸ” Search variants..." 
           onkeyup="filterGroupVariants()">
  </div>
  
  <!-- Variants List -->
  <div class="product-list-compact" id="groupVariantsList">
    <!-- Variants will be rendered here -->
  </div>
</div>




    
  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Create Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" 
                   required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6 class="border-bottom pb-2">Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 12%" class="text-center">Quantity</th>
                    <th style="width: 15%" class="text-end">Rate (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹)</th>
                    <th style="width: 18%" class="text-end">Amount (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹)</th>
                    <th style="width: 5%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-6"></div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" style="width: 150px" id="invoiceSubtotal">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Discount:</span>
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 70px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Tax (GST):</span>
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 90px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18" selected>18%</option>
                      <option value="28">28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr class="table-success fw-bold">
                  <td class="text-end"><h5 class="mb-0">Total (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹):</h5></td>
                  <td class="text-end"><h5 class="mb-0" id="invoiceGrandTotal">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer (e.g., delivery instructions, thank you message)">Thanks for your business.</textarea>
            <small class="text-muted">Optional message to include on the invoice</small>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link p-0" onclick="loadDefaultTerms()">
                <i class="bi bi-arrow-clockwise"></i> Use Default
              </button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="4" 
                      placeholder="Enter payment terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- Ã¢Å“â€¦ FIXED: Share Invoice Dropdown with proper attributes -->
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-primary dropdown-toggle" 
            data-bs-toggle="dropdown" 
            aria-expanded="false">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsImage()">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsPDF()">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>

 <!-- Ã¢Å“â€¦ NEW: Share image on specific WhatsApp number -->
  <li>
    <a class="dropdown-item" href="javascript:void(0);" onclick="shareImageToWhatsAppNumber()">
      <i class="bi bi-whatsapp text-success"></i> Share Image on WhatsApp
    </a>
  </li>
      
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaWhatsApp()">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaEmail()">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaSMS()">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>
      
    </div>
  </div>
</div>

<!-- VIEW INVOICES MODAL -->
<div class="modal fade" id="viewInvoicesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt-cutoff"></i> Saved Invoices
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <div id="invoicesListContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




  <!-- Add/Edit Product Modal (image removed) -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3">
          <div class="col-md-8"><label class="form-label">Product Name *</label><input id="productName" class="form-control" required/></div>
          <div class="col-md-4"><label class="form-label">Category *</label><select id="category" class="form-select" required><option value="">Select</option><option value="Tiles">Tiles</option><option value="Sanitaryware">Sanitaryware</option><option value="Accessories">Accessories</option></select></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><label class="form-label">Brand</label><input id="brand" class="form-control"/></div>
          <div class="col-md-6"><label class="form-label">Size</label><input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Unit Type *</label><select id="unitType" class="form-select" required><option value="Box">Box</option><option value="Piece">Piece</option><option value="SFT">Square Feet</option></select></div>
          <div class="col-md-4"><label class="form-label">Pieces per Box</label><input id="piecesPerBox" class="form-control" type="number" value="1"/></div>
          <div class="col-md-4"><label class="form-label">SFT per Box</label><input id="sftPerBox" class="form-control" type="number" step="0.01"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Price per Unit *</label><input id="price" class="form-control" type="number" step="0.01" required/></div>
          <div class="col-md-4"><label class="form-label">Current Stock *</label><input id="stock" class="form-control" type="number" required/></div>
          <div class="col-md-4"><label class="form-label">Minimum Stock</label><input id="minStock" class="form-control" type="number" value="5"/></div>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- SALES MODAL (grid) - top buttons removed, kept within body below grid -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Record New Sale</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">

      <!-- ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Multi-Select Product Picker -->
  <div class="mb-3">
    <label class="form-label fw-bold">
      <i class="bi bi-lightning-charge-fill text-warning"></i> Quick Add Products (Multi-Select)
    </label>
    <div class="multi-select-dropdown">
      <button type="button" class="form-control text-start multi-select-toggle" id="multiSelectToggle" onclick="toggleMultiSelect()">
        <span id="multiSelectLabel">Click to select multiple products...</span>
        <i class="bi bi-chevron-down float-end"></i>
      </button>
      <div class="multi-select-options" id="multiSelectOptions">
        <input type="text" class="form-control form-control-sm mb-2" 
               placeholder="ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒâ€šÃ‚Â Search products..." 
               id="multiSelectSearch" 
               oninput="filterMultiSelectOptions()">
        <div class="multi-select-list" id="multiSelectList">
          <!-- Checkboxes populated by JS -->
        </div>
      </div>
    </div>
    <small class="text-muted">Select multiple products to auto-fill rows below</small>
  </div>



      
      <!-- ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Buttons at TOP -->
  <div class="mb-3 text-end">
    <button class="btn btn-outline-primary btn-sm me-2" onclick="addMoreRows()">
      <i class="bi bi-plus-circle"></i> Add More Rows
    </button>
    <button class="btn btn-outline-success btn-sm" onclick="openCustomProductPopup()">
      <i class="bi bi-pencil-square"></i> Add Custom Product
    </button>
  </div>
      <div class="table-responsive">
        <table class="table table-sm grid-table mb-0">
          <thead><tr><th class="grid-row-number">#</th><th>Product Name</th><th style="width:130px">Size</th><th style="width:90px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Price</th><th style="width:140px">Total</th><th style="width:60px"></th></tr></thead>
          <tbody id="product-grid-body"></tbody>
        </table>
      </div>

      <!-- Keep Add buttons only here (below grid) -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()"><i class="bi bi-plus-circle"></i> Add More Rows</button>
          <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()"><i class="bi bi-pencil-square"></i> Add Custom Product</button>
        </div>
        <div class="text-end" style="min-width:320px;">
          <table class="table table-borderless mb-0">
            <tr><td class="text-end small-muted"><strong>Subtotal:</strong></td><td id="subtotal" class="text-end">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td></tr>
            <tr style="font-size:1.25rem;color:#28a745"><td class="text-end"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" class="text-end">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td></tr>
          </table>
        </div>
      </div>
    </div>

   <div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-info" onclick="generateInvoice()">
    <i class="bi bi-receipt"></i> Generate Invoice
  </button>
  <button class="btn btn-success" onclick="completeSale()">Complete Sale</button>
</div>

  </div></div></div>

  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>


        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</div></div>
      </form>
    </div>

<!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6>Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Rate</th>
                    <th style="width: 20%">Amount</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-7"></div>
            <div class="col-md-5">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" id="invoiceSubtotal">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Discount:
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 80px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Tax:
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 100px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">GST 5%</option>
                      <option value="12">GST 12%</option>
                      <option value="18" selected>GST 18%</option>
                      <option value="28">GST 28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</td>
                </tr>
                <tr class="table-success">
                  <td class="text-end"><h5>Total (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹):</h5></td>
                  <td class="text-end"><h5 id="invoiceGrandTotal">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer...">Thanks for your business.</textarea>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link" onclick="loadDefaultTerms()">Use Default</button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="3" 
                      placeholder="Enter terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- Ã¢Å“â€¦ NEW: Share Invoice Dropdown -->
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsImage(); return false;">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsPDF(); return false;">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaWhatsApp(); return false;">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaSMS(); return false;">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>

      
    </div>
  </div>
</div>

    
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>

<!-- ==========================================
     PRODUCT GROUPS - CREATE GROUP MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="createGroupModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeCreateGroupModal()">
      âœ• Cancel
    </button>
    <h3>New Item Group</h3>
    <div style="width: 80px;"></div> <!-- Spacer for centering -->
  </div>
  
  <form id="createGroupForm" class="mobile-form" onsubmit="handleCreateGroup(event)">
    
    <!-- Basic Information Section -->
    <div class="form-section">
      <div class="section-title">Basic Information</div>
      
      <label class="form-label">
        Item Group Name <span class="required">*</span>
      </label>
      <input 
        type="text" 
        id="groupName" 
        name="groupName"
        placeholder="e.g., T-Shirts, Tiles, Sanitaryware" 
        required
        autocomplete="off">
      
      <label class="form-label">Description</label>
      <textarea 
        id="groupDescription" 
        name="groupDescription"
        placeholder="Optional: Add a description for this group"
        rows="3"></textarea>
      
      <label class="form-label">Manufacturer / Brand</label>
      <input 
        type="text" 
        id="groupManufacturer" 
        name="groupManufacturer"
        placeholder="e.g., Nike, Somany"
        autocomplete="off">
      
      <label class="form-label">Category</label>
      <select id="groupCategory" name="groupCategory">
        <option value="">Select Category</option>
        <option value="Tiles">Tiles</option>
        <option value="Sanitaryware">Sanitaryware</option>
        <option value="Accessories">Accessories</option>
        <option value="Apparel">Apparel</option>
        <option value="Custom">Custom</option>
      </select>
    </div>
    
    <!-- Attributes Section -->
    <div class="form-section">
      <div class="section-title">Create Attributes & Options</div>
      <div class="section-description">
        Add attributes like Size, Color, Material, etc. Each combination will create a variant.
      </div>
      
      <div id="attributesContainer">
        <!-- Attribute rows will be added here dynamically -->
      </div>
      
      <button type="button" class="btn-add-more" onclick="addAttributeRow()">
        âž• Add Attribute
      </button>
    </div>
    
    <!-- Variant Preview Section -->
    <div class="form-section">
      <div class="variant-preview-section">
        <div class="variant-count-badge">
          <span id="variantCount">0</span> Variants Will Be Created
        </div>
        <div class="variant-preview-list" id="variantPreviewContainer">
          <div class="variant-preview-item">
            Add attributes to see preview...
          </div>
        </div>
      </div>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeCreateGroupModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom" id="btnSaveGroup">
        ðŸ’¾ Save & Generate
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     PRODUCT GROUPS - EDIT VARIANT MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="editVariantModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeEditVariantModal()">
      âœ• Cancel
    </button>
    <h3>Edit Variant</h3>
    <div style="width: 80px;"></div>
  </div>
  
  <form id="editVariantForm" class="mobile-form" onsubmit="handleUpdateVariant(event)">
    <input type="hidden" id="editVariantId">
    <input type="hidden" id="editVariantGroupId">
    
    <!-- Variant Info (Read-only) -->
    <div class="form-section">
      <div class="section-title">Variant Information</div>
      
      <label class="form-label">Variant Name</label>
      <input 
        type="text" 
        id="editVariantName" 
        readonly
        style="background: #f5f5f5; color: #666;">
      
      <label class="form-label">Attributes</label>
      <div id="editVariantAttributes" style="padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 14px; color: #666;">
        <!-- Attributes will be displayed here -->
      </div>
    </div>
    
    <!-- Pricing Section -->
    <div class="form-section">
      <div class="section-title">Pricing</div>
      
      <label class="form-label">Cost Price</label>
      <input 
        type="number" 
        id="editVariantCostPrice" 
        name="costPrice"
        placeholder="0.00"
        step="0.01"
        min="0">
      
      <label class="form-label">Selling Price <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantSellingPrice" 
        name="sellingPrice"
        placeholder="0.00"
        step="0.01"
        min="0"
        required>
    </div>
    
    <!-- Inventory Section -->
    <div class="form-section">
      <div class="section-title">Inventory</div>
      
      <label class="form-label">Stock Quantity <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantStock" 
        name="stock"
        placeholder="0"
        min="0"
        required>
      
      <label class="form-label">Minimum Stock Alert</label>
      <input 
        type="number" 
        id="editVariantMinStock" 
        name="minStock"
        placeholder="0"
        min="0">
      
      <label class="form-label">Unit Type</label>
      <select id="editVariantUnitType" name="unitType">
        <option value="Piece">Piece</option>
        <option value="Box">Box</option>
        <option value="SFT">SFT</option>
        <option value="Set">Set</option>
        <option value="Unit">Unit</option>
      </select>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeEditVariantModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom">
        ðŸ’¾ Save Changes
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     SUCCESS MESSAGE OVERLAY
     ========================================== -->

<div class="success-overlay" id="successOverlay">
  <div style="font-size: 32px; margin-bottom: 8px;">âœ…</div>
  <div id="successMessage">Success!</div>
</div>

  

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">



    <!-- Ã¢Å“â€¦ NEW: Photo Product Modal -->
<div class="modal fade" id="photoProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ã°Å¸â€œâ€¢ Add Product by Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Photo Upload Area -->
        <div class="upload-area" id="photoUploadArea" onclick="document.getElementById('photoFileInput').click()">
          <div class="upload-icon">Ã°Å¸â€œâ€¢</div>
          <div class="upload-text">Click to take photo or select from gallery</div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoSelect(event)">
        <input type="file" id="photoCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect(event)">
        
        <!-- Photo Preview -->
        <div id="photoPreviewContainer" class="preview-container">
          <img id="photoPreviewImage" class="preview-image" alt="Product Photo">
          <button type="button" class="btn btn-sm btn-warning" onclick="clearPhotoSelection()">Change Photo</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="photoLoadingSpinner" class="loading-spinner">
          <div class="spinner"></div>
          <p>Uploading photo...</p>
        </div>
        
        <!-- Product Details Form -->
        <div class="mb-3">
          <label class="form-label">Product Name <span class="text-danger">*</span></label>
          <input type="text" id="photoProductName" class="form-control" placeholder="e.g., White Marble Tile" required>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Brand</label>
            <input type="text" id="photoProductBrand" class="form-control" placeholder="Optional">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Size</label>
            <input type="text" id="photoProductSize" class="form-control" placeholder="e.g., 2x2">
          </div>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" id="photoProductStock" class="form-control" min="0" placeholder="0">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Unit Price (Ã¢â€šÂ¹)</label>
            <input type="number" id="photoProductPrice" class="form-control" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Only products with stock and price can be sold.</small>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePhotoProduct()">
          <i class="bi bi-check-circle"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Ã¢Å“â€¦ NEW: View Photo Modal (Enlarged View) -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewPhotoModalTitle">Product Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewPhotoModalBody">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>


  <script src="s://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>


    
    
  /***********************
   * CONFIG
   ***********************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2XYfQVwAUX4kzPOBliZym7RnvqxFiZ7XjblQu86v2UYi5G1VaBQp77taT0sGeJnr0/exec'; // <-- replace with your deployed URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2XYfQVwAUX4kzPOBliZym7RnvqxFiZ7XjblQu86v2UYi5G1VaBQp77taT0sGeJnr0/exec'
  let cachedProducts = [];
  let cachedSales = [];

 // âœ… NEW: Product Groups cache
let cachedProductGroups = [];
let cachedGroupVariants = [];

// âœ… NEW: Page state management
let currentPage = 'home'; // home, allProducts, productGroups, groupDetail
let currentGroupId = null; // For group detail view

    
    
// ==========================================
// BACKGROUND SAVE QUEUE
// ==========================================

const backgroundSaveQueue = [];
let isProcessingQueue = false;
let backgroundSyncActive = false;

// ==========================================
// EMAIL + PASSWORD AUTHENTICATION (WITH HASH)
// ==========================================

let currentUser = null;
let userEmail = null;
let userHash = null; // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Store encrypted hash

// Simple hash function (matches backend)
function simpleHash(text) {
  let hash = 0;
  if (text.length === 0) return hash.toString();
  for (let i = 0; i < text.length; i++) {
    const char = text.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36);
}

// Toggle password visibility
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.className = 'bi bi-eye-slash';
  } else {
    passwordInput.type = 'password';
    toggleIcon.className = 'bi bi-eye';
  }
}

// Check authentication on page load
window.addEventListener('load', async function() {
  console.log('ÃƒÂ°Ã…Â¸Ã…Â¡Ã¢â€šÂ¬ Page loaded, checking authentication...');
  
  // Check localStorage for saved credentials
  const savedEmail = localStorage.getItem('userEmail');
  const savedHash = localStorage.getItem('userHash');
  const savedUser = localStorage.getItem('currentUser');
  
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã‚Â¦ Checking localStorage:', {
    hasEmail: !!savedEmail,
    hasHash: !!savedHash,
    hasUser: !!savedUser
  });
  
  if (savedEmail && savedHash) {
    console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Found saved credentials, auto-logging in...');
    
    try {
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ SET VARIABLES FIRST
      userEmail = savedEmail;
      userHash = savedHash;
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
      } else {
        currentUser = {
          email: savedEmail,
          name: savedEmail.split('@')[0],
          authorized: true
        };
      }
      
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Session restored:', { userEmail, hasHash: !!userHash });
      
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Show app IMMEDIATELY
      showApp();
      updateUserUI();
      
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Wait before syncing
      setTimeout(async () => {
        console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ Starting data sync...');
        await syncFromGoogleSheets();
      }, 500);
      
    } catch (error) {
      console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Error restoring session:', error);
      showAuthScreen();
    }
  } else {
    console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ËœÃ‚Â¤ No saved credentials, showing login screen...');
    showAuthScreen();
  }
});

// Handle email + password authentication
async function handleEmailPasswordAuth(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const loginButton = document.getElementById('loginButton');
  
  const email = emailInput.value.trim().toLowerCase();
  const password = passwordInput.value;
  
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ‚Â Authenticating:', email);
  
  // Show loading state
  const originalText = loginButton.innerHTML;
  loginButton.disabled = true;
  loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  
  try {
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Send email + password to backend
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=authenticate&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok && data.user && data.hash) {
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ SUCCESS - Save email + hash
      userEmail = email;
      userHash = data.hash;
      currentUser = data.user;
      
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Save to localStorage for permanent login
      localStorage.setItem('userEmail', email);
      localStorage.setItem('userHash', data.hash);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Authentication successful');
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Hash saved to localStorage');
      
      // Clear password field
      passwordInput.value = '';
      
      // Show app and load data
      showApp();
      updateUserUI();
      
      setTimeout(async () => {
        await syncFromGoogleSheets();
      }, 300);
      
    } else {
      // ÃƒÂ¢Ã‚ÂÃ…â€™ FAILED
      console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Authentication failed:', data);
      alert(data.message || 'Invalid email or password');
      loginButton.disabled = false;
      loginButton.innerHTML = originalText;
      passwordInput.value = '';
      passwordInput.focus();
    }
    
  } catch (error) {
    console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Authentication error:', error);
    alert('Failed to authenticate. Please check your internet connection and try again.');
    loginButton.disabled = false;
    loginButton.innerHTML = originalText;
  }
}

// Clear authentication
function clearAuth() {
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬â€Ã¢â‚¬ËœÃƒÂ¯Ã‚Â¸Ã‚Â Clearing authentication...');
  userEmail = null;
  userHash = null;
  currentUser = null;
  localStorage.removeItem('userEmail');
  localStorage.removeItem('userHash');
  localStorage.removeItem('currentUser');
}

// Show authentication screen
function showAuthScreen() {
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã‚Â± Showing auth screen');
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('appContent').style.display = 'none';
  
  // Pre-fill email if saved
  const savedEmail = localStorage.getItem('userEmail');
  if (savedEmail) {
    document.getElementById('userEmailInput').value = savedEmail;
    document.getElementById('userPasswordInput').focus();
  }
}

// Show app
function showApp() {
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã‚Â± Showing app');
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appContent').style.display = 'block';
}

// Update user UI
function updateUserUI() {
  if (currentUser) {
    const userNameEl = document.getElementById('userName');
    
    if (userNameEl) {
      userNameEl.textContent = currentUser.name || currentUser.email;
      console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ËœÃ‚Â¤ Updated username:', currentUser.email);
    }
  }
}

// Show auth error
function showAuthError(message) {
  console.warn('ÃƒÂ°Ã…Â¸Ã…Â¡Ã‚Â¨ Auth error:', message);
  
  if (message && (message.includes('unauthorized') || message.includes('not authorized') || message.includes('expired'))) {
    clearAuth();
    alert('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬â„¢ ' + message);
    showAuthScreen();
  } else {
    console.log('ÃƒÂ¢Ã…Â¡ ÃƒÂ¯Ã‚Â¸Ã‚Â Non-critical error, keeping credentials');
  }
}

// Sign out
function signOut() {
  if (confirm('Are you sure you want to sign out?')) {
    console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ËœÃ¢â‚¬Â¹ Signing out...');
    clearAuth();
    showAuthScreen();
    setTimeout(() => location.reload(), 300);
  }
}

// ==========================================
// CHANGE PASSWORD FUNCTIONALITY
// ==========================================

let changePasswordModalInstance = null;

// Open change password modal
function openChangePasswordModal() {
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Ëœ Opening change password modal');
  
  // Reset form
  document.getElementById('verifyPasswordStep').style.display = 'block';
  document.getElementById('newPasswordStep').style.display = 'none';
  document.getElementById('currentPasswordInput').value = '';
  document.getElementById('newPasswordInput').value = '';
  document.getElementById('confirmPasswordInput').value = '';
  
  // Show modal
  const modalEl = document.getElementById('changePasswordModal');
  if (!changePasswordModalInstance) {
    changePasswordModalInstance = new bootstrap.Modal(modalEl);
  }
  changePasswordModalInstance.show();
}

// Verify current password (Step 1)
async function verifyCurrentPassword() {
  const currentPasswordInput = document.getElementById('currentPasswordInput');
  const currentPassword = currentPasswordInput.value;
  
  if (!currentPassword) {
    alert('Please enter your current password');
    return;
  }
  
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ‚Â Verifying current password...');
  
  try {
    // Verify by attempting authentication
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=authenticate&email=${encodeURIComponent(userEmail)}&password=${encodeURIComponent(currentPassword)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok) {
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Password correct - show step 2
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Current password verified');
      document.getElementById('verifyPasswordStep').style.display = 'none';
      document.getElementById('newPasswordStep').style.display = 'block';
      document.getElementById('newPasswordInput').focus();
    } else {
      // ÃƒÂ¢Ã‚ÂÃ…â€™ Wrong password
      alert('Current password is incorrect');
      currentPasswordInput.value = '';
      currentPasswordInput.focus();
    }
    
  } catch (error) {
    console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Error verifying password:', error);
    alert('Failed to verify password. Please try again.');
  }
}

// Submit new password (Step 2)
async function submitNewPassword() {
  const currentPasswordInput = document.getElementById('currentPasswordInput');
  const newPasswordInput = document.getElementById('newPasswordInput');
  const confirmPasswordInput = document.getElementById('confirmPasswordInput');
  
  const oldPassword = currentPasswordInput.value;
  const newPassword = newPasswordInput.value;
  const confirmPassword = confirmPasswordInput.value;
  
  // Validate inputs
  if (!newPassword || !confirmPassword) {
    alert('Please fill in all fields');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('New password must be at least 6 characters');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('Passwords do not match');
    confirmPasswordInput.value = '';
    confirmPasswordInput.focus();
    return;
  }
  
  if (newPassword === oldPassword) {
    alert('New password must be different from current password');
    newPasswordInput.value = '';
    confirmPasswordInput.value = '';
    newPasswordInput.focus();
    return;
  }
  
  console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ Changing password...');
  
  try {
    // Send change password request
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=changePassword&email=${encodeURIComponent(userEmail)}&oldPassword=${encodeURIComponent(oldPassword)}&newPassword=${encodeURIComponent(newPassword)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok && data.hash) {
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ SUCCESS - Update hash in localStorage
      userHash = data.hash;
      localStorage.setItem('userHash', data.hash);
      
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Password changed successfully');
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ New hash saved');
      
      // Close modal
      changePasswordModalInstance.hide();
      
      // Show success message
      alert('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Password changed successfully!');
      
    } else {
      // ÃƒÂ¢Ã‚ÂÃ…â€™ FAILED
      alert(data.message || 'Failed to change password');
    }
    
  } catch (error) {
    console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Error changing password:', error);
    alert('Failed to change password. Please try again.');
  }
}



let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }

/**
 * ==========================================
 * CREATE PRODUCT GROUP FUNCTIONS
 * ==========================================
 */

// Global state for group creation
let groupAttributes = {}; // { "Size": ["Small", "Medium", "Large"], "Color": ["Red", "Blue"] }
let generatedVariants = []; // Array of variant objects

// Open Create Group Modal
function openCreateGroupModal() {
  // Reset form
  document.getElementById('groupName').value = '';
  document.getElementById('groupDescription').value = '';
  document.getElementById('groupCategory').value = '';
  document.getElementById('groupBrand').value = '';
  
  // Reset attributes
  groupAttributes = {};
  generatedVariants = [];
  document.getElementById('attributesContainer').innerHTML = '';
  
  // Reset steps
  document.getElementById('groupStep1').style.display = 'block';
  document.getElementById('groupStep2').style.display = 'none';
  document.getElementById('groupNextBtn').style.display = 'inline-block';
  document.getElementById('groupSaveBtn').style.display = 'none';
  document.getElementById('groupBackBtn').style.display = 'none';
  
  // Add first attribute row
  addAttributeRow();
  
  // Update preview
  updateVariantPreview();
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
  modal.show();
}

// Add attribute row
function addAttributeRow() {
  const container = document.getElementById('attributesContainer');
  const rowId = 'attr-' + Date.now();
  
  const rowHtml = `
    <div class="attribute-row" id="${rowId}">
      <div style="flex:1;">
        <label class="form-label small">Attribute Name</label>
        <input type="text" 
               class="form-control form-control-sm attr-name" 
               placeholder="e.g., Size, Color, Material" 
               onchange="updateVariantPreview()">
      </div>
      <div style="flex:2;">
        <label class="form-label small">Options (comma-separated)</label>
        <input type="text" 
               class="form-control form-control-sm attr-options" 
               placeholder="e.g., Small, Medium, Large" 
               onchange="updateVariantPreview()">
        <div class="attribute-options-container" id="${rowId}-tags"></div>
      </div>
      <button class="btn-remove" onclick="removeAttributeRow('${rowId}')">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', rowHtml);
}

// Remove attribute row
function removeAttributeRow(rowId) {
  const row = document.getElementById(rowId);
  if (row) {
    row.remove();
    updateVariantPreview();
  }
}

// Update variant preview
function updateVariantPreview() {
  // Collect attributes from form
  groupAttributes = {};
  
  const attrRows = document.querySelectorAll('.attribute-row');
  attrRows.forEach(row => {
    const nameInput = row.querySelector('.attr-name');
    const optionsInput = row.querySelector('.attr-options');
    
    if (nameInput && optionsInput) {
      const name = nameInput.value.trim();
      const optionsStr = optionsInput.value.trim();
      
      if (name && optionsStr) {
        // Parse options (comma-separated)
        const options = optionsStr.split(',').map(o => o.trim()).filter(o => o);
        if (options.length > 0) {
          groupAttributes[name] = options;
          
          // Show tags
          const tagsContainer = row.querySelector('.attribute-options-container');
          if (tagsContainer) {
            tagsContainer.innerHTML = options.map(opt => 
              `<span class="attribute-option-tag">${escapeHtml(opt)}</span>`
            ).join('');
          }
        }
      }
    }
  });
  
  // Generate variant combinations
  generatedVariants = generateVariantCombinations(groupAttributes);
  
  // Update preview
  const previewList = document.getElementById('variantPreviewList');
  const countEl = document.getElementById('variantCount');
  
  if (generatedVariants.length === 0) {
    previewList.innerHTML = '<small class="text-muted">Add attributes above to see variant preview</small>';
    countEl.innerHTML = 'Total variants: <strong>0</strong>';
  } else {
    previewList.innerHTML = generatedVariants.map((v, i) => 
      `<div>${i + 1}. ${escapeHtml(v.name)}</div>`
    ).join('');
    countEl.innerHTML = `Total variants: <strong>${generatedVariants.length}</strong>`;
  }
}

// Generate variant combinations
function generateVariantCombinations(attributes) {
  const attrNames = Object.keys(attributes);
  
  if (attrNames.length === 0) {
    return [];
  }
  
  // Get base name from group name input
  const groupName = document.getElementById('groupName').value.trim() || 'Product';
  
  // Generate all combinations
  function combine(index, current, currentAttrs) {
    if (index === attrNames.length) {
      results.push({
        name: current,
        attributes: { ...currentAttrs }
      });
      return;
    }
    
    const attrName = attrNames[index];
    const options = attributes[attrName];
    
    options.forEach(option => {
      const newCurrent = current ? `${current}-${option}` : `${groupName}-${option}`;
      const newAttrs = { ...currentAttrs, [attrName]: option };
      combine(index + 1, newCurrent, newAttrs);
    });
  }
  
  const results = [];
  combine(0, '', {});
  return results;
}

// Go to Step 2 (Variant Details)
function goToGroupStep2() {
  // Validate Step 1
  const groupName = document.getElementById('groupName').value.trim();
  
  if (!groupName) {
    alert('âŒ Please enter a group name');
    return;
  }
  
  if (Object.keys(groupAttributes).length === 0) {
    alert('âŒ Please add at least one attribute with options');
    return;
  }
  
  if (generatedVariants.length === 0) {
    alert('âŒ No variants generated. Please check your attributes.');
    return;
  }
  
  // Generate variant detail forms
  renderVariantDetailForms();
  
  // Show Step 2
  document.getElementById('groupStep1').style.display = 'none';
  document.getElementById('groupStep2').style.display = 'block';
  document.getElementById('groupNextBtn').style.display = 'none';
  document.getElementById('groupSaveBtn').style.display = 'inline-block';
  document.getElementById('groupBackBtn').style.display = 'inline-block';
}

// Go back to Step 1
function goToGroupStep1() {
  document.getElementById('groupStep1').style.display = 'block';
  document.getElementById('groupStep2').style.display = 'none';
  document.getElementById('groupNextBtn').style.display = 'inline-block';
  document.getElementById('groupSaveBtn').style.display = 'none';
  document.getElementById('groupBackBtn').style.display = 'none';
}

// Render variant detail forms (Step 2)
function renderVariantDetailForms() {
  const container = document.getElementById('variantDetailsContainer');
  
  let html = '';
  
  generatedVariants.forEach((variant, index) => {
    html += `
      <div class="variant-detail-card">
        <h6>${escapeHtml(variant.name)}</h6>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small">Price (â‚¹)</label>
            <input type="number" 
                   class="form-control form-control-sm variant-price" 
                   data-index="${index}"
                   placeholder="0.00" 
                   step="0.01"
                   min="0">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Stock</label>
            <input type="number" 
                   class="form-control form-control-sm variant-stock" 
                   data-index="${index}"
                   placeholder="0" 
                   min="0">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Min Stock</label>
            <input type="number" 
                   class="form-control form-control-sm variant-minstock" 
                   data-index="${index}"
                   placeholder="5" 
                   value="5"
                   min="0">
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Copy first variant price to all
function copyPriceToAll() {
  const firstPriceInput = document.querySelector('.variant-price[data-index="0"]');
  if (!firstPriceInput || !firstPriceInput.value) {
    alert('âŒ Please enter price for the first variant first');
    return;
  }
  
  const price = firstPriceInput.value;
  const allPriceInputs = document.querySelectorAll('.variant-price');
  
  allPriceInputs.forEach(input => {
    input.value = price;
  });
  
  alert('âœ… Price copied to all variants');
}

// Save Product Group
async function saveProductGroup() {
  try {
    // Collect group data
    const groupName = document.getElementById('groupName').value.trim();
    const groupDescription = document.getElementById('groupDescription').value.trim();
    const groupCategory = document.getElementById('groupCategory').value;
    const groupBrand = document.getElementById('groupBrand').value.trim();
    
    if (!groupName) {
      alert('âŒ Please enter a group name');
      return;
    }
    
    if (generatedVariants.length === 0) {
      alert('âŒ No variants to save');
      return;
    }
    
    // Collect variant details from Step 2
    const variantDetails = [];
    let hasError = false;
    
    generatedVariants.forEach((variant, index) => {
      const priceInput = document.querySelector(`.variant-price[data-index="${index}"]`);
      const stockInput = document.querySelector(`.variant-stock[data-index="${index}"]`);
      const minStockInput = document.querySelector(`.variant-minstock[data-index="${index}"]`);
      
      const price = parseFloat(priceInput.value) || 0;
      const stock = parseInt(stockInput.value) || 0;
      const minStock = parseInt(minStockInput.value) || 5;
      
      if (price <= 0) {
        alert(`âŒ Please enter a valid price for: ${variant.name}`);
        hasError = true;
        return;
      }
      
      variantDetails.push({
        variantName: variant.name,
        attributes: variant.attributes,
        price: price,
        stock: stock,
        minStock: minStock,
        brand: groupBrand,
        category: groupCategory
      });
    });
    
    if (hasError) return;
    
    showLoading('Creating product group...');
    
    // Step 1: Create the group
    const groupData = {
      groupName: groupName,
      description: groupDescription,
      attributes: groupAttributes
    };
    
    const groupResponse = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'createProductGroup',
        email: localStorage.getItem('userEmail') || '',
        hash: localStorage.getItem('userHash') || '',
        data: JSON.stringify(groupData)
      })
    });
    
    const groupResult = await groupResponse.json();
    
    if (!groupResult.ok || !groupResult.groupId) {
      hideLoading();
      showError('Failed to create group: ' + (groupResult.error || 'Unknown error'));
      return;
    }
    
    const groupId = groupResult.groupId;
    
    // Step 2: Create all variants
    const variantsData = {
      groupId: groupId,
      groupName: groupName,
      variants: variantDetails
    };
    
    const variantsResponse = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'createGroupVariants',
        email: localStorage.getItem('userEmail') || '',
        hash: localStorage.getItem('userHash') || '',
        data: JSON.stringify(variantsData)
      })
    });
    
    const variantsResult = await variantsResponse.json();
    
    hideLoading();
    
    if (!variantsResult.ok) {
      showError('Group created but failed to create variants: ' + (variantsResult.error || 'Unknown error'));
      return;
    }
    
    // Success!
    showSuccess(`âœ… Product group "${groupName}" created with ${variantDetails.length} variants!`);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
    if (modal) {
      modal.hide();
    }
    
    // Refresh product groups
    await syncProductGroups();
    await syncAllVariants();
    
    // If on product groups page, refresh the view
    if (currentPage === 'productGroups') {
      renderProductGroupsList();
    }
    
    // Update dashboard
       updateDashboard();
    
  } catch (error) {
    hideLoading();
    console.error('Error saving product group:', error);
    showError('Error creating product group: ' + error.message);
  }
}





  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/**
 * Sync / Fetch from Google Sheets
 * Combines authentication check + complete data fetching + sales filtering
 */
async function syncFromGoogleSheets() {
  if (!userEmail || !userHash) {
    console.warn('ÃƒÂ¢Ã…Â¡ ÃƒÂ¯Ã‚Â¸Ã‚Â No credentials, checking localStorage...');
    const savedEmail = localStorage.getItem('userEmail');
    const savedHash = localStorage.getItem('userHash');
    if (savedEmail && savedHash) {
      userEmail = savedEmail;
      userHash = savedHash;
      console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Restored credentials from localStorage');
    } else {
      console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ËœÃ‚Â¤ No credentials found');
      showAuthScreen();
      return;
    }
  }

  showSyncIndicator('Refreshing...');
  
  try {
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Send email + hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=getAll&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}&t=${Date.now()}`;

    const res = await fetch(url);
    
    if (!res.ok) {
      throw new Error(`Network error: ${res.status}`);
    }
    
    const data = await res.json();
    
    // Check for unauthorized response
    if (!data.success && data.error === 'unauthorized') {
      // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ ONLY clear auth on real unauthorized error
      console.error('ÃƒÂ¢Ã‚ÂÃ…â€™ Email not authorized');
      clearAuth();
      alert('Access denied. Your email is not authorized. Please contact administrator.');
      showAuthScreen();
      hideSyncIndicator();
      return;
    }
    
    // Verify successful response
    if (data && data.success) {
      // Update products
      cachedProducts = data.products || [];
      
      // Update sales with filtering for deleted items
      let allSales = data.sales || [];
      
      // Filter out manually deleted sales
      cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
      console.log(`ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã…  Loaded ${allSales.length} sales from server, showing ${cachedSales.length} (${allSales.length - cachedSales.length} deleted)`);
      
      // Sort sales by date (newest first)
      sortSalesByDateDescending();
      
      // Mark initial load complete
      hasInitialLoaded = true;
      
      // Render both products and sales
      renderProducts();
      renderSales();
      
      // Update dashboard metrics
      updateSummaryFromCache();
        // âœ… NEW: Sync product groups and variants
  await syncProductGroups();
  await syncAllVariants();
      showSyncIndicator('Synced!', 900);
      
    } else {
      throw new Error(data.error || 'Failed to fetch data');
    }
    
  } catch (err) {
    console.error('ÃƒÂ¢Ã…Â¡ ÃƒÂ¯Ã‚Â¸Ã‚Â Sync error (non-critical):', err);
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Don't show alert or clear auth on network errors
    hideSyncIndicator();
  }
}



  async function fallbackGetProductsAndSales() {
    try { const p = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`); if(p.ok){ const pj=await p.json(); if(pj && pj.products) cachedProducts=pj.products; } }
    catch(e){ console.warn('fallback products failed', e); }
    try { const s = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`); if(s.ok){ const sj=await s.json(); if(sj && sj.sales) cachedSales=sj.sales; } }
    catch(e){ console.warn('fallback sales failed', e); }
    hasInitialLoaded = true; renderProducts(); renderSales();
  }
  async function manualRefresh(){ const btn = document.getElementById('refreshBtn'); const icon=document.getElementById('refreshIcon'); btn.disabled=true; icon.className='bi bi-arrow-clockwise spinner-border spinner-border-sm'; await syncFromGoogleSheets(); icon.className='bi bi-arrow-clockwise'; btn.disabled=false; }

  /***********************
   * Rendering
   ***********************/
  function categoryIconColor(cat){
    if(!cat) return '#6c757d';
    const c = cat.toLowerCase();
    if(c.includes('tile')) return '#0d6efd';
    if(c.includes('sanitary')) return '#198754';
    if(c.includes('access')) return '#fd7e14';
    return '#6c757d';
  }

  function stockBadgeHtml(stock, minStock){
    minStock = (typeof minStock === 'number') ? minStock : Number(minStock)||5;
    stock = Number(stock)||0;
    if(stock === 0) return `<span class="stock-badge bg-danger text-white">Out of Stock</span>`;
    if(stock <= minStock) return `<span class="stock-badge bg-warning text-dark">Low (${stock})</span>`;
    return `<span class="stock-badge bg-success text-white">In Stock (${stock})</span>`;
  }

  function renderProducts(){
    const tbody = document.getElementById('productsTableBody');
    if(!hasInitialLoaded){
      tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¦</div></td></tr>`;
    } else if(!cachedProducts || cachedProducts.length===0){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
    } else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const priceText = (p.price!==undefined && p.price!==null) ? `ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
        html += `<tr>
          <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>   
<!-- Ã¢Å“â€¦ Photo Thumbnail Column -->
  <td style="text-align: center;">
    ${p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...' ? 
      `<img src="${p.imageUrl}" 
           class="photo-thumbnail-small" 
           alt="Photo" 
           onclick="viewPhotoProduct('${p.id}')"
           style="cursor:pointer; width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0;"
           onerror="this.onerror=null; this.src='https://via.placeholder.com/40?text=No+Img'; console.error('Image load failed for product: ${escapeHtml(p.name)}');">` : 
      `<i class="bi bi-image text-muted"></i>`}
  </td>
          
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.category||'')}</td>
          <td>${escapeHtml(p.brand||'')}</td>
          <td><strong>${escapeHtml(p.size||'')}</strong></td>
          <td>${stockBadgeHtml(p.stock,p.minStock)}</td>
          <td>${priceText}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i> Delete</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }
    // mobile list
    const container = document.getElementById('mobileProductsList');
    if(!hasInitialLoaded){ container.innerHTML=`<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¦</div></div>`; }
    else if(!cachedProducts || cachedProducts.length===0){ container.innerHTML=`<div class="mobile-item text-center text-muted">No products yet</div>`; }
    else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        html += `<div class="mobile-item d-flex align-items-start justify-content-between">
          <div style="display:flex;gap:.8rem;align-items:center;">
            <div style="width:36px;text-align:center;"><i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i></div>
            <div>
              <div style="font-weight:600">${escapeHtml(p.name)}</div>
              <div class="small-muted">${escapeHtml(p.category||'')} ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ ${escapeHtml(p.brand||'')}</div>
              <div class="small-muted"><strong>${escapeHtml(p.size||'')}</strong> ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${parseFloat(p.price||0).toFixed(2)}/${p.unitType}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div>${stockBadgeHtml(p.stock,p.minStock)}</div>
            <div style="margin-top:.5rem">
              <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }
    updateSummaryFromCache();
    loadProductsForSaleFromCache();
  }

  function renderSales(){
    const tbody = document.getElementById('salesList');
    
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading salesÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¦</div></td></tr>`; return; }
    
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    
    let html = '';
    
    const recent = (cachedSales || []).slice(0,100);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }

 function updateSummaryFromCache() {
  // Update Total Products
  const totalProductsEl = document.getElementById('totalProducts');
  if (totalProductsEl) {
    totalProductsEl.textContent = cachedProducts.length;
  }
  
  // Update Low Stock Items
  const lowStockCount = cachedProducts.filter(p => p.stock <= p.minStock).length;
  const lowStockEl = document.getElementById('lowStock');
  if (lowStockEl) {
    lowStockEl.textContent = lowStockCount;
  }
  
  // âœ… NEW: Update Products in Group counter
  const productsInGroupEl = document.getElementById('productsInGroup');
  if (productsInGroupEl) {
    // Calculate total variants across all groups
    const totalVariants = cachedProductGroups.reduce((sum, group) => {
      return sum + (group.totalVariants || 0);
    }, 0);
    productsInGroupEl.textContent = totalVariants;
  }
  
  // âœ… NEW: Update Inventory Summary (placeholder for now)
  const quantityInHandEl = document.getElementById('quantityInHand');
  if (quantityInHandEl) {
    quantityInHandEl.textContent = '0'; // TODO: Calculate from actual data
  }
  
  const quantityToBeReceivedEl = document.getElementById('quantityToBeReceived');
  if (quantityToBeReceivedEl) {
    quantityToBeReceivedEl.textContent = '0'; // TODO: Calculate from actual data
  }
}


  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }

 /***********************
 * Save helpers (server calls) - safe against CORS preflight + include idToken
 ***********************/
/**
 * Save product to Google Sheets
 */
async function saveProductToSheet(product, isEdit=false) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to save product'); 
    return null; 
  }
  
  try {
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=${isEdit ? 'updateProduct' : 'addProduct'}&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // "simple" content-type -> no preflight
      body: JSON.stringify(product)
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return null;
    }
    
    return parsed.json || null;
  } catch (e) {
    console.error('saveProductToSheet error', e);
    return null;
  }
}


/**
 * Save sale to Google Sheets
 */
async function saveSaleToSheet(item) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to save sale'); 
    return null; 
  }
  
  try {
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=addSale&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // avoid preflight
      body: JSON.stringify(item)
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return null;
    }
    
    return parsed.json || null;
  } catch (e) {
    console.error('saveSaleToSheet error', e);
    return null;
  }
}

    // ==========================================
// HELPER: Delay function
// ==========================================
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==========================================
// HELPER: Success Toast Notification
// ==========================================
function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div><strong>${message}</strong></div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast with animation
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide and remove after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast && toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// ==========================================
// HELPER: Update sync indicator
// ==========================================
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'flex' : 'none';
  }
}




  // ==========================================
// BACKGROUND QUEUE PROCESSOR
// ==========================================
async function processBackgroundSaveQueue() {
  if (isProcessingQueue) {
    console.log('ÃƒÂ¢Ã‚ÂÃ‚Â³ Queue processor already running');
    return;
  }
  
  if (backgroundSaveQueue.length === 0) {
    console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Queue empty, processor stopping');
    backgroundSyncActive = false;
    updateSyncIndicator(false);
    return;
  }
  
  isProcessingQueue = true;
  backgroundSyncActive = true;
  updateSyncIndicator(true);
  
  console.log(`ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ Processing ${backgroundSaveQueue.length} items in background queue...`);
  
  while (backgroundSaveQueue.length > 0) {
    const item = backgroundSaveQueue[0]; // Peek at first item
    
    console.log(`ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã‚Â¤ Background saving: "${item.productName}" (${backgroundSaveQueue.length} remaining)`);
    
    // Try to save with retry logic
    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const response = await saveSaleToSheet(item);
        
        if (response && response.success) {
          console.log(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Background saved: "${item.productName}"`);
          saved = true;
          break;
        }
        
        // If not last attempt, wait before retry
        if (attempt < 3) {
          console.log(`ÃƒÂ¢Ã…Â¡ ÃƒÂ¯Ã‚Â¸Ã‚Â Retry ${attempt}/3 for "${item.productName}" in ${attempt}s...`);
          await delay(1000 * attempt); // 1s, 2s backoff
        }
        
      } catch (error) {
        console.error(`ÃƒÂ¢Ã‚ÂÃ…â€™ Attempt ${attempt}/3 failed for "${item.productName}":`, error);
        
        if (attempt < 3) {
          await delay(1000 * attempt);
        }
      }
    }
    
    if (saved) {
      // Successfully saved - remove from queue
      backgroundSaveQueue.shift();
    } else {
      // Failed after 3 retries - log error and remove
      console.error(`ÃƒÂ¢Ã‚ÂÃ…â€™ PERMANENT FAILURE: Could not save "${item.productName}" after 3 attempts`);
      console.error('Failed item data:', item);
      
      // Remove from queue to prevent infinite loop
      backgroundSaveQueue.shift();
      
      // Optional: Store in localStorage for manual recovery
      try {
        const failedItems = JSON.parse(localStorage.getItem('failedSales') || '[]');
        failedItems.push({
          item: item,
          timestamp: new Date().toISOString(),
          error: 'Max retries exceeded'
        });
        localStorage.setItem('failedSales', JSON.stringify(failedItems));
        console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬â„¢Ã‚Â¾ Failed item saved to localStorage for recovery');
      } catch (e) {
        console.error('Could not save to localStorage:', e);
      }
    }
    
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ CRITICAL: Delay between items to prevent throttling
    if (backgroundSaveQueue.length > 0) {
      await delay(500); // 500ms delay between saves
    }
  }
  
  isProcessingQueue = false;
  backgroundSyncActive = false;
  updateSyncIndicator(false);
  
  console.log('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Background queue processing complete!');
  
  // Optional: Silent background sync after all saves complete
  setTimeout(() => {
    console.log('ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ Starting background sync from Google Sheets...');
    syncFromGoogleSheets();
  }, 2000);
}


// Helper: Delay function
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Helper: Update sync indicator
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'block' : 'none';
  }
}


/**
 * Delete product from Google Sheets
 */
async function deleteProductFromSheet(id) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to delete product'); 
    return false; 
  }
  
  try {
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=deleteProduct&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // avoid preflight
      body: JSON.stringify({ id })
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return false;
    }
    
    return parsed.json && parsed.json.success;
  } catch (e) {
    console.error('deleteProductFromSheet error', e);
    return false;
  }
}



  /***********************
   * Product CRUD UI
   ***********************/
  let editingProductId = null;
  function showAddProduct(){ editingProductId=null; document.getElementById('modalTitle').textContent='Add New Product'; document.getElementById('productForm').reset(); document.getElementById('productId').value=''; new bootstrap.Modal(document.getElementById('productModal')).show(); }
  function editProduct(id){
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if(!p){ alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Product not found'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent='Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;

  // Ã¢Å“â€¦ CRITICAL: Preserve imageUrl when editing
  // Store it in a hidden field or variable
  window.editingProductImageUrl = p.imageUrl || '';
    
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }

 async function saveProduct() {
  const name = document.getElementById('productName').value.trim();
  const category = document.getElementById('category').value;
  const brand = document.getElementById('brand').value.trim();
  const size = document.getElementById('size').value.trim();
  const unitType = document.getElementById('unitType').value;
  const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
  const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value);
  const minStock = parseInt(document.getElementById('minStock').value) || 5;
  
  if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0) {
    alert('Fill required fields');
    return;
  }
  
  const product = {
    id: editingProductId || (Date.now().toString(36) + Math.random().toString(36).substr(2)),
    name: name,
    category: category,
    brand: brand,
    size: size,
    unitType: unitType,
    piecesPerBox: piecesPerBox,
    sftPerBox: sftPerBox,
    price: price,
    stock: stock,
    minStock: minStock,
    imageUrl: window.editingProductImageUrl || ''  // Ã¢Å“â€¦ PRESERVE IMAGE URL
  };
  
  const idx = cachedProducts.findIndex(p => p.id === product.id);
  const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
  
  if (idx !== -1) {
    cachedProducts[idx] = product;
  } else {
    cachedProducts.push(product);
  }
  
  renderProducts();
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
  if (modal) modal.hide();
  
  showSyncIndicator('Saving product...');
  
  // Background save
  saveProductToSheet(product, !!editingProductId).then(resp => {
    if (resp && resp.success) {
      if (resp.id) {
        const localIdx = cachedProducts.findIndex(p => p.id === product.id);
        if (localIdx !== -1) cachedProducts[localIdx].id = resp.id;
        renderProducts();
      }
      showSyncIndicator('Saved', 900);
    }
  }).catch(err => {
    console.error(err);
    if (previous) {
      cachedProducts[idx] = previous;
      renderProducts();
    }
    alert('Save failed - reverted locally.');
  });
  
  // Clear the temporary imageUrl variable
  window.editingProductImageUrl = '';
}

  

  function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) {
    return;
  }
  
  const prev = cachedProducts.slice();
  cachedProducts = cachedProducts.filter(p => p.id !== id);
  renderProducts();
  
  // Also update photo grid if currently viewing it
  if (document.getElementById('btnPhotoView').classList.contains('active')) {
    showPhotoProducts();
  }
  
  showSyncIndicator('Deleting...');
  
  deleteProductFromSheet(id).then(success => {
    if (success) {
      showSyncIndicator('Deleted', 900);
    } else {
      cachedProducts = prev;
      renderProducts();
      if (document.getElementById('btnPhotoView').classList.contains('active')) {
        showPhotoProducts();
      }
      alert('Delete failed - reverted locally.');
    }
  });
}


  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){
  initSalesGrid();
  populateMultiSelect(); // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Populate multi-select
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// Ã¢Å“â€¦ CORRECTED: Multi-Select Functions with Photo Support
function populateMultiSelect() {
    const container = document.getElementById('multiSelectList');
    if (!container) return;
    
    let html = '';
    
    cachedProducts
        .filter(p => {
            // Include photo products ONLY if they have stock AND price
            if (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') {
                const hasStockAndPrice = p.stock > 0 && p.price > 0;
                console.log(`Photo product "${p.name}": stock=${p.stock}, price=${p.price}, showing=${hasStockAndPrice}`);
                return hasStockAndPrice;
            }
            // Include regular products with stock
            return p.stock > 0;
        })
        .forEach(product => {
            // Add photo thumbnail if available
            const photoHTML = (product.imageUrl && product.imageUrl !== 'uploading...') ? 
                `<img src="${product.imageUrl}" 
                     class="photo-thumbnail-small" 
                     alt="${escapeHtml(product.name)}" 
                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0; margin-right:8px; vertical-align:middle;"
                     onerror="this.style.display='none'; console.error('Failed to load image for: ${escapeHtml(product.name)}');">` : '';
            
            html += `
                <div class="multi-select-item">
                    <div class="form-check">
                        <input class="form-check-input multi-select-checkbox" type="checkbox" 
                               id="multi-${product.id}" 
                               value="${product.id}"
                               onchange="onMultiSelectChange()">
                        ${photoHTML}
                        <label class="form-check-label" for="multi-${product.id}">
                            ${escapeHtml(product.name)} 
                            <small class="text-muted">(Stock: ${product.stock} ${product.unitType})</small>
                        </label>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html || '<small class="text-muted">No products available</small>';
    
    // Debug: Log how many products are shown
    console.log(`Multi-select populated with ${cachedProducts.filter(p => p.stock > 0).length} products`);
}



function toggleMultiSelect() {
    const options = document.getElementById('multiSelectOptions');
    options.classList.toggle('show');
}

function filterMultiSelectOptions() {
    const searchTerm = document.getElementById('multiSelectSearch').value.toLowerCase();
    const items = document.querySelectorAll('.multi-select-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function onMultiSelectChange() {
    const checkedProducts = [];
    
    // Get all checked checkboxes
    document.querySelectorAll('.multi-select-checkbox:checked').forEach(checkbox => {
        const productId = checkbox.value;
        const product = cachedProducts.find(p => p.id === productId);
        if (product) {
            checkedProducts.push(product);
        }
    });
    
    // Update label
    const label = document.getElementById('multiSelectLabel');
    if (checkedProducts.length === 0) {
        label.innerHTML = 'Click to select multiple products...';
    } else {
        label.innerHTML = `<strong>${checkedProducts.length} product${checkedProducts.length > 1 ? 's' : ''} selected</strong>`;
    }
    
    // Auto-populate rows
    ensureEnoughRows(checkedProducts.length);
    populateRowsWithSelectedProducts(checkedProducts);
}

function ensureEnoughRows(needed) {
    const currentRows = document.querySelectorAll('#product-grid-body tr').length;
    if (needed > currentRows) {
        const rowsToAdd = needed - currentRows;
        for (let i = 0; i < rowsToAdd; i++) {
            const currentCount = document.querySelectorAll('#product-grid-body tr').length;
            appendEmptyRow(currentCount + 1);
        }
        updateRowNumbers();
    }
}

function populateRowsWithSelectedProducts(products) {
    products.forEach((product, index) => {
        const rowIndex = index + 1;
        
        // Select product in dropdown
        const select = document.getElementById(`product-${rowIndex}`);
        if (select) {
            select.value = product.id;
            onProductSelect(rowIndex); // Trigger auto-fill
        }
    });
    
    updateGrandTotal();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.multi-select-dropdown');
    const options = document.getElementById('multiSelectOptions');
    if (dropdown && !dropdown.contains(e.target) && options) {
        options.classList.remove('show');
    }
});



    
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled placeholder="Enter quantity" oninput="onQtyChange(${index})"></td>

      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

 function removeRow(btn) {
  const tr = btn.closest('tr')
  if(!tr) return
  
  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Don't actually delete the row - just clear/reset it
  const select = tr.querySelector('.product-select')
  const sizeEl = tr.querySelector('.size-input')
  const qtyEl = tr.querySelector('.qty-input')
  const unitEl = tr.querySelector('.unit-input')
  const priceEl = tr.querySelector('.price-input')
  const totalEl = tr.querySelector('[id^="total-"]')
  
  // If custom product, remove from array
  if(select && select.value && select.value.startsWith('CUST_TMP_')) {
    customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value)
  }
  
  // Reset all fields to empty/default state
  if(select) {
    select.value = ''
    select.disabled = false
  }
  if(sizeEl) sizeEl.value = ''
  if(unitEl) unitEl.value = ''
  if(priceEl) priceEl.value = ''
  if(qtyEl) {
    qtyEl.value = ''
    qtyEl.disabled = true // Disable until product selected
    qtyEl.removeAttribute('max')
  }
  if(totalEl) totalEl.textContent = formatCurrency(0)
  
  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ CRITICAL: Get row index and re-attach event listener
  const rowIndex = Array.from(tr.parentNode.children).indexOf(tr) + 1;
  
  if(select) {
    // Re-populate select options
    populateProductSelectForRow(rowIndex);
    
    // Re-attach onchange handler
    select.onchange = function() {
      onProductSelect(rowIndex);
    };
  }
  
  updateGrandTotal()
}


  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã‚Â¾ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
function openCustomProductPopup() {
  document.getElementById('customProductForm').reset();
  document.getElementById('customTotal').textContent = 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹0.00';
  new bootstrap.Modal(document.getElementById('customProductModal'), {backdrop: 'static'}).show();
  setTimeout(() => document.getElementById('customName').focus(), 200);
}

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

function validateCustomProduct() {
  const name = document.getElementById('customName').value.trim();
  const qty = Number(document.getElementById('customQty').value || 0);
  const price = Number(document.getElementById('customPrice').value || 0);
  
  if (!name || name.length < 2) {
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Product name required (min 2 chars)');
    return false;
  }
  
  if (!qty || qty < 1) {
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Quantity must be at least 1');
    return false;
  }
  
  if (!price || price <= 0) {
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Unit price must be greater than 0');
    return false;
  }
  
  return true;
}


function addCustomProductToGrid() {
  if (!validateCustomProduct()) return;
  
  const name = document.getElementById('customName').value.trim();
  const size = document.getElementById('customSize').value.trim() || 'N/A';
  const qty = Number(document.getElementById('customQty').value || 0);
  const unitType = document.getElementById('customUnit').value || 'Box';
  const price = Number(document.getElementById('customPrice').value || 0);
  
  const tempId = 'CUST_TMP_' + Date.now().toString(36); // Unique temp id
  
  // Store in persistent array
  const cp = {
    tempId: tempId,
    name: name,
    size: size,
    unitType: unitType,
    price: price,
    quantity: qty
  };
  
  customProductsInSale.push(cp);
  
  // Find first empty row or append new row
  let idx = findFirstEmptyRowIndex();
  if (!idx) {
    const count = document.querySelectorAll('#product-grid-body .product-row').length;
    appendEmptyRow(count + 1);
    updateRowNumbers();
    idx = count + 1;
  }
  
  // Populate row with custom data
  populateRowWithCustom(idx, cp);
  updateGrandTotal();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal'));
  if (modal) modal.hide();
  
  // Show success
  alert(`ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Custom product "${name}" added to sale!`);
}


function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    
    // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Make quantity editable for custom products
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    qtyEl.disabled = false;  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Keep enabled
    qtyEl.readOnly = false;  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Not read-only
    qtyEl.value = cp.quantity;
    qtyEl.max = cp.quantity; // Can increase up to this amount
    
    // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ NEW: Add event listener to update total when quantity changes
    qtyEl.addEventListener('input', function() {
        const newQty = parseFloat(this.value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
        const total = newQty * price;
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
        updateGrandTotal();
    });
    
    // Set initial total
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * cp.quantity);
}



  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }

  /***********************
   * COMPLETE SALE (fire-and-forget background saves)
   ***********************/
 /**
 * ==========================================
 * ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIXED: Sequential sale saving with delay
 * ==========================================
 */

// ==========================================
// COMPLETE SALE - OPTIMISTIC UI + BACKGROUND SAVE
// ==========================================

// ==========================================
// COMPLETE SALE - OPTIMISTIC UI + BACKGROUND SAVE
// ==========================================
async function completeSale() {
  // Collect valid sale items from the form
  const saleItems = [];
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const saleId = 'SALE_' + Date.now().toString(36);
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return; // Skip empty rows
    }
    
    const productId = sel.value;
    const quantity = Number(qtyEl.value);
    const unitPrice = Number(document.getElementById(`price-${idx}`).value || 0);
    const totalAmount = quantity * unitPrice;
    const size = document.getElementById(`size-${idx}`).value || 'N/A';
    const unitType = document.getElementById(`unit-${idx}`).value || '';
    
    // Check if custom product
    const isCustom = productId.startsWith('CUST_TMP_');
    let productName = '';
    
    if (isCustom) {
      const cp = customProductsInSale.find(c => c.tempId === productId);
      productName = cp ? cp.name : 'Custom Product';
    } else {
      const prod = cachedProducts.find(p => p.id === productId);
      productName = prod ? prod.name : 'Unknown Product';
    }
    
    saleItems.push({
      saleId: saleId,
      productId: isCustom ? '' : productId,
      productName: productName,
      size: size,
      quantity: quantity,
      unitType: unitType,
      unitPrice: unitPrice,
      totalAmount: totalAmount,
      isCustomProduct: isCustom
    });
  });
  
  // Validation
  if (saleItems.length === 0) {
    alert('ÃƒÂ¢Ã…Â¡ ÃƒÂ¯Ã‚Â¸Ã‚Â No products selected. Please add at least one product to complete the sale.');
    return;
  }
  
  const totalAmount = saleItems.reduce((sum, item) => sum + item.totalAmount, 0);
  
  if (!confirm(`ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã‚Â¦ Complete sale with ${saleItems.length} item(s)?\n\nTotal: ${formatCurrency(totalAmount)}`)) {
    return;
  }
  
  console.log(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Sale confirmed: ${saleItems.length} items, total ${formatCurrency(totalAmount)}`);
  
  // ==========================================
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ STEP 1: INSTANT UI UPDATES (< 100ms)
  // ==========================================
  
  // Add to local cache immediately
  saleItems.forEach(item => {
    const newSale = {
      id: generateId(),
      saleId: item.saleId,
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      unitType: item.unitType,
      unitPrice: item.unitPrice,
      totalAmount: item.totalAmount,
      date: new Date().toISOString(),
      isCustomProduct: item.isCustomProduct
    };
    cachedSales.unshift(newSale);
    
    // Update stock locally (for non-custom products)
    if (!item.isCustomProduct && item.productId) {
      const prod = cachedProducts.find(p => p.id === item.productId);
      if (prod) {
        prod.stock -= item.quantity;
      }
    }
  });
  
  // Re-render UI immediately
  renderProducts();
  renderSales();
  updateSummaryFromCache();
  
  // Close modal immediately
  const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (modal) modal.hide();
  
  // Reset custom products array
  customProductsInSale = [];
  
  // Show success toast notification
  showSuccessToast(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Sale completed! ${saleItems.length} item(s) recorded.`);
  
  console.log(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ UI updated instantly - ${saleItems.length} items displayed`);
  
  // ==========================================
  // ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ STEP 2: BACKGROUND SAVE TO GOOGLE SHEETS
  // ==========================================
  
  // Add items to background save queue
  saleItems.forEach(item => {
    backgroundSaveQueue.push(item);
  });
  
  console.log(`ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ¢â‚¬Å¾ Added ${saleItems.length} items to background save queue (queue size: ${backgroundSaveQueue.length})`);
  
  // Start background processor (if not already running)
  if (!isProcessingQueue) {
    setTimeout(() => {
      processBackgroundSaveQueue();
    }, 100); // Small delay to let UI settle
  } else {
    console.log('ÃƒÂ¢Ã‚ÂÃ‚Â³ Background processor already running, items will be processed in sequence');
  }
}


    // ==========================================
// SUCCESS TOAST NOTIFICATION
// ==========================================

function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 3000);
}

  
  


  /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }

  /***********************
   * Backup/Import
   ***********************/
  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦ Backup downloaded');
  }
  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(evt){ try{ const data = JSON.parse(evt.target.result); if(data.products) cachedProducts = data.products; if(data.sales) cachedSales = data.sales; hasInitialLoaded=true; renderProducts(); renderSales(); alert('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦ Data restored (local)'); }catch(err){ alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Invalid file'); } }; reader.readAsText(file); }

      function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // Filter products
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category || '').toLowerCase();
        const brand = (product.brand || '').toLowerCase();
        const size = (product.size || '').toLowerCase();
        
        return name.includes(searchTerm) ||
               category.includes(searchTerm) ||
               brand.includes(searchTerm) ||
               size.includes(searchTerm);
    });
    
    // Display filtered products
    displayProducts(filteredProducts);
}

function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search"></i>
                    <p>No products found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const iconColor = categoryIconColor(product.category);
        const stockClass = product.stock > product.minStock ? 'In Stock' : 
                          product.stock > 0 ? 'Low' : 'Out of Stock';
        const stockBadgeClass = product.stock > product.minStock ? 'bg-success' : 
                               product.stock > 0 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <tr>
                <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
                <td>${escapeHtml(product.name)}</td>
                <td>${escapeHtml(product.category)}</td>
                <td>${escapeHtml(product.brand) || '-'}</td>
                <td><strong>${escapeHtml(product.size) || 'N/A'}</strong></td>
                <td><span class="badge ${stockBadgeClass}">${stockClass} (${product.stock})</span></td>
                <td>ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${product.price.toFixed(2)}/${product.unitType}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Also update mobile list
    const container = document.getElementById('mobileProductsList');
    if (products.length === 0) {
        container.innerHTML = '<div class="mobile-item text-center text-muted">No products found</div>';
        return;
    }
    
    let mobileHtml = '';
    products.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between">
                <div style="display:flex;gap:.8rem;align-items:center">
                    <div style="width:36px;text-align:center">
                        <i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600">${escapeHtml(p.name)}</div>
                        <div class="small-muted">${escapeHtml(p.category)} ${escapeHtml(p.brand)}</div>
                        <div class="small-muted"><strong>${escapeHtml(p.size)}</strong> ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${parseFloat(p.price || 0).toFixed(2)}/${p.unitType}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    ${stockBadge}
                    <div style="margin-top:.5rem">
                        <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = mobileHtml;
}

function displayAllProducts() {
    displayProducts(cachedProducts);
}


    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã‚Â¾ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¹ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\nÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¡ ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦ FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â‚¬Å¾Ã‚Â¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¾ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦ Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}


   function displaySalesFromCache() {
  const salesList = document.getElementById('salesList');
  
  if (cachedSales.length === 0) {
    salesList.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  salesList.innerHTML = '';
  
  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Show only last 100 sales (most recent)
  const recentSales = cachedSales.slice(0, 100);
  
  recentSales.forEach(sale => {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                         date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
    
    const row = `
      <tr>
        <td>${formattedDate}</td>
        <td>${sale.productName}</td>
        <td>${sale.quantity}</td>
        <td>${sale.unitType}</td>
        <td class="text-success fw-bold">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${parseFloat(sale.totalAmount).toFixed(2)}</td>
      </tr>
    `;
    
    salesList.innerHTML += row;
  });
  
  // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Show count if more than 100 sales exist
  if (cachedSales.length > 100) {
    salesList.innerHTML += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          <small>Showing 100 most recent sales. Total: ${cachedSales.length} sales</small>
        </td>
      </tr>
    `;
  }
}

/**
 * ==========================================
 * Ã¢Å“â€¦ PHOTO PRODUCT FUNCTIONALITY
 * ==========================================
 */

// Photo selection variables
let selectedPhotoFile = null;
let selectedPhotoBase64 = null;

// Open photo product modal
function openPhotoProductModal() {
  // Reset form
  document.getElementById('photoProductName').value = '';
  document.getElementById('photoProductBrand').value = '';
  document.getElementById('photoProductSize').value = '';
  document.getElementById('photoProductStock').value = '';
  document.getElementById('photoProductPrice').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
  document.getElementById('photoLoadingSpinner').style.display = 'none';
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('photoProductModal'));
  modal.show();
}

// Handle photo selection
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  selectedPhotoFile = file;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      selectedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      document.getElementById('photoPreviewImage').src = selectedPhotoBase64;
      document.getElementById('photoPreviewContainer').style.display = 'block';
      
      console.log('Photo selected and compressed:', file.name);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Clear photo selection
function clearPhotoSelection() {
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  document.getElementById('photoFileInput').value = '';
  document.getElementById('photoCameraInput').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
}

// Save photo product
async function savePhotoProduct() {
  const productName = document.getElementById('photoProductName').value.trim();
  if (!productName) {
    alert('Product name is required!');
    return;
  }
  
  if (!selectedPhotoBase64) {
    alert('Please take or select a photo!');
    return;
  }
  
  const productData = {
    id: generateId(),
    name: productName,
    category: 'Photo Products',
    brand: document.getElementById('photoProductBrand').value.trim() || '',
    size: document.getElementById('photoProductSize').value.trim() || '',
    unitType: 'Piece',
    piecesPerBox: '',
    sftPerBox: '',
    price: parseFloat(document.getElementById('photoProductPrice').value) || 0,
    stock: parseFloat(document.getElementById('photoProductStock').value) || 0,
    minStock: 0,
    imageUrl: 'uploading...'
  };
  
  cachedProducts.push(productData);
  renderProducts();
  
  const modalEl = document.getElementById('photoProductModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
  
  showSuccessToast('Photo product added! Uploading image...');
  
  uploadPhotoToBackend(productData, selectedPhotoBase64);
}

// Upload photo to backend
async function uploadPhotoToBackend(productData, photoBase64) {
  try {
    console.log('Uploading photo to Google Drive...');
    
    document.getElementById('photoLoadingSpinner').style.display = 'block';
    
    const formData = new URLSearchParams({
      action: 'uploadPhoto',
      email: userEmail,
      hash: userHash,
      imageData: photoBase64,
      fileName: `product_${productData.id}_${Date.now()}.jpg`
    });
    
    const photoResponse = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      body: formData,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    const photoResult = await photoResponse.json();
    
    if (photoResult.success && photoResult.photoUrl) {
      console.log('Photo uploaded successfully:', photoResult.photoUrl);
      
      productData.imageUrl = photoResult.photoUrl;
      
      const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
      if (productIndex !== -1) {
        cachedProducts[productIndex].imageUrl = photoResult.photoUrl;
      }
      
      await saveProductToSheet(productData);
      
      renderProducts();
      showSuccessToast('Ã¢Å“â€¦ Photo uploaded successfully!');
      
    } else {
      throw new Error(photoResult.error || 'Photo upload failed');
    }
    
  } catch (error) {
    console.error('Photo upload error:', error);
    alert('Failed to upload photo. Product saved without image.');
    
    productData.imageUrl = '';
    
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = '';
    }
    
    await saveProductToSheet(productData);
    renderProducts();
    
  } finally {
    document.getElementById('photoLoadingSpinner').style.display = 'none';
  }
}

// Show all products (table view)
function showAllProducts() {
  document.getElementById('btnAllView').classList.add('active');
  document.getElementById('btnPhotoView').classList.remove('active');
  
  document.querySelector('.table-explorer').style.display = 'block';
  document.getElementById('photoProductGrid').style.display = 'none';
  
  renderProducts();
}
// Show photo products (grid view)
function showPhotoProducts() {
  document.getElementById('btnAllView').classList.remove('active');
  document.getElementById('btnPhotoView').classList.add('active');
  
  document.querySelector('.table-explorer').style.display = 'none';
  const photoGrid = document.getElementById('photoProductGrid');
  photoGrid.style.display = 'flex';
  photoGrid.innerHTML = '';
  
  // Filter photo products
  const photoProducts = cachedProducts.filter(p => {
    const hasImage = p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...';
    console.log(`Product "${p.name}": imageUrl="${p.imageUrl}", showing=${hasImage}`);
    return hasImage;
  });
  
  console.log(`Found ${photoProducts.length} photo products`);
  
  if (photoProducts.length === 0) {
    photoGrid.innerHTML = `
      <div class="col-12">
        <div class="alert alert-info text-center">
          <i class="bi bi-images" style="font-size: 3rem;"></i><br>
          <strong>No photo products yet.</strong><br>
          Click <strong>"Product by Photo"</strong> to add one!
        </div>
      </div>
    `;
    return;
  }
  
  photoProducts.forEach(product => {
    const stockBadge = product.stock > 0 ? 
      `<span class="badge bg-success">Stock: ${product.stock}</span>` : 
      `<span class="badge bg-danger">Out of Stock</span>`;
    
    const priceDisplay = product.price > 0 ? `Ã¢â€šÂ¹${product.price.toFixed(2)}` : 'Price not set';
    
    const card = `
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="${product.imageUrl}" 
               class="card-img-top" 
               alt="${escapeHtml(product.name)}" 
               style="height:200px; object-fit:cover; cursor:pointer;" 
               onclick="viewPhotoProduct('${product.id}')"
               onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Image+Not+Found'; console.error('Failed to load image for card: ${escapeHtml(product.name)}');">
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(product.name)}</h6>
            <p class="card-text small mb-2">
              ${product.brand ? `<strong>Brand:</strong> ${escapeHtml(product.brand)}<br>` : ''}
              ${product.size ? `<strong>Size:</strong> ${escapeHtml(product.size)}<br>` : ''}
              ${stockBadge}<br>
              <strong>Price:</strong> ${priceDisplay}
            </p>
          </div>
          <div class="card-footer bg-white border-0 d-flex gap-2">
            <!-- Ã¢Å“â€¦ FIXED: Call editProduct which opens the correct modal -->
            <button class="btn btn-sm btn-primary flex-fill" onclick="editProduct('${product.id}')">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <!-- Ã¢Å“â€¦ FIXED: Call deleteProduct with proper confirmation -->
            <button class="btn btn-sm btn-danger flex-fill" onclick="deleteProduct('${product.id}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    `;
    photoGrid.innerHTML += card;
  });
}



// View photo product enlarged
function viewPhotoProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) {
    alert('Product not found');
    return;
  }
  
  document.getElementById('viewPhotoModalTitle').textContent = product.name;
  document.getElementById('viewPhotoModalBody').innerHTML = `
    <div class="text-center">
      <img src="${product.imageUrl}" 
           class="img-fluid mb-3" 
           alt="${product.name}"
           style="max-height: 500px; border-radius: 10px;"
           onerror="this.src='https://via.placeholder.com/500?text=Image+Not+Found'">
      <table class="table table-bordered mt-3">
        <tr><th>Product Name</th><td>${product.name}</td></tr>
        <tr><th>Category</th><td>${product.category || 'N/A'}</td></tr>
        <tr><th>Brand</th><td>${product.brand || 'N/A'}</td></tr>
        <tr><th>Size</th><td>${product.size || 'N/A'}</td></tr>
        <tr><th>Stock</th><td>${product.stock || 0} ${product.unitType || 'Pieces'}</td></tr>
        <tr><th>Price</th><td>Ã¢â€šÂ¹${formatCurrency(product.price || 0)}</td></tr>
        <tr><th>Minimum Stock Alert</th><td>${product.minStock || 0}</td></tr>
      </table>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
  modal.show();
}


 /**
 * ==========================================
 * INITIALIZATION ON PAGE LOAD
 * ==========================================
 */

// Init
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸš€ Initializing Inventory App...');
  
  // Set initial page to home
  currentPage = 'home';
  
  // Make sure all page views start hidden
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    console.log('âœ… All Products page hidden');
  }
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    console.log('âœ… Product Groups page hidden');
  }
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    console.log('âœ… Group Detail page hidden');
  }
  
  // Initialize main dashboard display
  const mainApp = document.getElementById('mainApp');
  if (mainApp) {
    mainApp.style.display = 'block';
    console.log('âœ… Main dashboard visible');
  }
  
  // Initialize data (existing code)
  renderProducts();
  renderSales();
  syncFromGoogleSheets();
  
  console.log('âœ… Page navigation initialized');
});



    /***********************
 * INVOICE GENERATOR
 ***********************/

// Global variable to store invoice number counter
let invoiceCounter = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');

function generateInvoice() {
  // Collect products from sale grid
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const items = [];
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    const priceEl = document.getElementById(`price-${idx}`);
    const sizeEl = document.getElementById(`size-${idx}`);
    
    // Skip if no product selected or no quantity
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return; // Continue to next iteration
    }
    
    // Get clean product name without stock info
    let productName = sel.options[sel.selectedIndex]?.text || 'Product';
    // Remove stock information (e.g., "Stock: 147 Box")
    productName = productName.replace(/\(Stock:.*?\)/g, '').trim();
    
    const quantity = Number(qtyEl.value);
    const rate = Number(priceEl.value) || 0;
    const size = sizeEl.value;
    
    items.push({
      name: productName,
      size: size,
      quantity: quantity,
      rate: rate,
      amount: quantity * rate
    });
  });
  
  if (items.length === 0) {
    alert('Ã¢Å¡ Ã¯Â¸Â No products in the sale! Add products before generating invoice.');
    return;
  }
  
  // Store items temporarily
  window.tempInvoiceItems = items;
  
  // Ã¢Å“â€¦ FIX: Close Sales Modal BEFORE opening Invoice Modal
  const salesModal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (salesModal) {
    salesModal.hide();
  }
  
  // Wait for sales modal to close, then open invoice modal
  setTimeout(() => {
    openInvoiceModal();
  }, 300); // 300ms delay ensures smooth transition
}



function openInvoiceModal() {

  
  // Check if modal exists
  const modalEl = document.getElementById('invoiceModal');
  
  
  if (!modalEl) {
    
    return;
  }
  
  
  // Generate invoice number
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  
  const invoiceNumEl = document.getElementById('invoiceNumber');
  
  if (invoiceNumEl) {
    invoiceNumEl.value = invoiceNo;
  }
  
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  
 
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('invoiceDate');
  if (dateEl) {
    dateEl.value = today;
  }
  

  calculateDueDate();
  populateInvoiceItems();
  loadDefaultTerms();
  
  // Show modal
  try {
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
 
  } catch (error) {
    
  }
}


// Regenerate Invoice Number
function regenerateInvoiceNumber() {
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  document.getElementById('invoiceNumber').value = invoiceNo;
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
}

// Calculate Due Date based on Payment Terms
function calculateDueDate() {
  const invoiceDate = new Date(document.getElementById('invoiceDate').value);
  const terms = parseInt(document.getElementById('paymentTerms').value);
  
  const dueDate = new Date(invoiceDate);
  dueDate.setDate(dueDate.getDate() + terms);
  
  document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
}

// Populate Invoice Items from Sale
function populateInvoiceItems() {
  const tbody = document.getElementById('invoiceItemsBody');
  tbody.innerHTML = '';
  
  if (!window.tempInvoiceItems || window.tempInvoiceItems.length === 0) return;
  
  window.tempInvoiceItems.forEach((item, index) => {
    const row = createInvoiceRow(item, index);
    tbody.innerHTML += row;
  });
  
  calculateInvoiceTotal();
}

// Create Invoice Row HTML
function createInvoiceRow(item, index) {
  const itemName = item.size ? `${item.name} (${item.size})` : item.name;
  return `
    <tr data-index="${index}">
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="${escapeHtml(itemName)}" 
               oninput="calculateInvoiceTotal()">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-center invoice-qty" 
               value="${item.quantity}" min="1" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end invoice-rate" 
               value="${item.rate}" min="0" step="0.01" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td class="text-end fw-bold invoice-row-total">
        ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${(item.quantity * item.rate).toFixed(2)}
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-link text-danger" 
                onclick="deleteInvoiceRow(${index})">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  `;
}

// Update Invoice Row Total
function updateInvoiceRowTotal(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (!row) return;
  
  const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
  const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
  const total = qty * rate;
  
  row.querySelector('.invoice-row-total').textContent = formatCurrency(total);
  calculateInvoiceTotal();
}

// Delete Invoice Row
function deleteInvoiceRow(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (row) {
    row.remove();
    calculateInvoiceTotal();
  }
}

// Add New Invoice Row
function addInvoiceRow() {
  const tbody = document.getElementById('invoiceItemsBody');
  const index = tbody.querySelectorAll('tr').length;
  
  const newItem = {
    name: '',
    size: '',
    quantity: 1,
    rate: 0,
    amount: 0
  };
  
  tbody.innerHTML += createInvoiceRow(newItem, index);
}

// Calculate Invoice Total
function calculateInvoiceTotal() {
  // Calculate subtotal
  let subtotal = 0;
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.invoice-qty')?.value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate')?.value) || 0;
    subtotal += qty * rate;
  });
  
  document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
  
  // Calculate discount
  const discountValue = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
  const discountType = document.getElementById('invoiceDiscountType').value;
  let discount = 0;
  
  if (discountType === 'amount') {
    discount = discountValue;
  } else {
    discount = (subtotal * discountValue) / 100;
  }
  
  document.getElementById('invoiceDiscountAmount').textContent = '-' + formatCurrency(discount);
  
  // Calculate tax
  const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
  const taxableAmount = subtotal - discount;
  const tax = (taxableAmount * taxRate) / 100;
  
  document.getElementById('invoiceTaxAmount').textContent = formatCurrency(tax);
  
  // Calculate grand total
  const grandTotal = taxableAmount + tax;
  document.getElementById('invoiceGrandTotal').textContent = formatCurrency(grandTotal);
}

// Load Default Terms & Conditions
function loadDefaultTerms() {
  const defaultTerms = `1. Payment due within 14 days of invoice date
2. Late payments subject to 2% monthly interest charge
3. Goods once sold cannot be returned or exchanged
4. Delivery charges may apply for orders under ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹10,000
5. Company not responsible for damages during transit`;
  
  document.getElementById('invoiceTerms').value = defaultTerms;
}

// Save Invoice
async function saveInvoice() {
  // Validate required fields
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  
  if (!customerName) {
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Please enter customer name');
    return;
  }
  
  // Collect invoice data
  const invoiceData = collectInvoiceData();
  
  // Save to localStorage
  let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  invoices.push(invoiceData);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert('ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Invoice saved successfully!\n\nInvoice Number: ' + invoiceData.invoiceNumber);
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
  if (modal) modal.hide();
}

// Collect Invoice Data
function collectInvoiceData() {
  const items = [];
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value;
    const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
    
    if (name && qty > 0) {
      items.push({
        name: name,
        quantity: qty,
        rate: rate,
        amount: qty * rate
      });
    }
  });
  
  const subtotal = parseFloat(document.getElementById('invoiceSubtotal').textContent.replace(/[ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹,]/g, ''));
  const discount = parseFloat(document.getElementById('invoiceDiscountAmount').textContent.replace(/[ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹,-]/g, ''));
  const tax = parseFloat(document.getElementById('invoiceTaxAmount').textContent.replace(/[ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹,]/g, ''));
  const total = parseFloat(document.getElementById('invoiceGrandTotal').textContent.replace(/[ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹,]/g, ''));
  
  return {
    invoiceNumber: document.getElementById('invoiceNumber').value,
    customerName: document.getElementById('invoiceCustomerName').value,
    invoiceDate: document.getElementById('invoiceDate').value,
    dueDate: document.getElementById('invoiceDueDate').value,
    items: items,
    subtotal: subtotal,
    discount: discount,
    tax: tax,
    total: total,
    notes: document.getElementById('invoiceNotes').value,
    terms: document.getElementById('invoiceTerms').value,
    createdAt: new Date().toISOString()
  };
}

// Preview Invoice
function previewInvoice() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Please enter customer name');
    return;
  }
  
  // Generate HTML for invoice
  const invoiceHTML = generateInvoiceHTML(invoiceData);
  
  // Open in new window
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

// Generate Invoice HTML for Preview/Print
function generateInvoiceHTML(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align: center">${index + 1}</td>
        <td>${escapeHtml(item.name)}</td>
        <td style="text-align: center">${item.quantity}</td>
        <td style="text-align: right">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${item.rate.toFixed(2)}</td>
        <td style="text-align: right">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${data.invoiceNumber}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        .invoice-header { text-align: center; margin-bottom: 30px; }
        .invoice-details { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background-color: #f8f9fa; }
        .text-right { text-align: right; }
        .total-row { font-weight: bold; background-color: #e9ecef; }
        @media print {
          button { display: none; }
        }
      </style>
      </div> <!-- End of appContent -->

    </head>
    
    <body>
      <div class="invoice-header">
        <h1>INVOICE</h1>
        <h3>Tile & Sanitaryware Inventory</h3>
      </div>
      
      <div class="invoice-details">
        <p><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
        <p><strong>Customer Name:</strong> ${data.customerName}</p>
        <p><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
        <p><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
      </div>
      
      <table>
        <thead>
          <tr>
            <th style="width: 50px">#</th>
            <th>Item Description</th>
            <th style="width: 100px">Quantity</th>
            <th style="width: 120px">Rate</th>
            <th style="width: 120px">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <table style="width: 400px; margin-left: auto">
        <tr>
          <td>Sub Total:</td>
          <td class="text-right">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${data.subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Discount:</td>
          <td class="text-right">-ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${data.discount.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Tax:</td>
          <td class="text-right">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${data.tax.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
          <td>Grand Total:</td>
          <td class="text-right">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${data.total.toFixed(2)}</td>
        </tr>
      </table>
      
      <div style="margin-top: 30px">
        <p><strong>Customer Notes:</strong></p>
        <p>${data.notes || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 20px">
        <p><strong>Terms & Conditions:</strong></p>
        <p style="white-space: pre-line">${data.terms || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 40px; text-align: center">
        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer">
          Print Invoice
        </button>
      </div>

     </body>
    </html>
  `;
}
            

// ==========================================
// VIEW SAVED INVOICES FEATURE
// ==========================================

function viewSavedInvoices() {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  
  const container = document.getElementById('invoicesListContainer');
  
  if (invoices.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No saved invoices found
      </div>
    `;
  } else {
    let html = `
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
          <thead class="table-light">
            <tr>
              <th style="width: 15%">Invoice No</th>
              <th style="width: 20%">Customer Name</th>
              <th style="width: 12%">Date</th>
              <th style="width: 12%">Due Date</th>
              <th style="width: 10%" class="text-end">Total</th>
              <th style="width: 18%">Items</th>
              <th style="width: 13%" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    invoices.forEach((inv, index) => {
      const itemsCount = inv.items ? inv.items.length : 0;
      const itemsSummary = inv.items ? inv.items.slice(0, 2).map(i => i.name).join(', ') : '';
      const moreItems = itemsCount > 2 ? ` +${itemsCount - 2} more` : '';
      
      html += `
        <tr>
          <td><strong>${inv.invoiceNumber}</strong></td>
          <td>${escapeHtml(inv.customerName)}</td>
          <td>${new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</td>
          <td>${new Date(inv.dueDate).toLocaleDateString('en-IN')}</td>
          <td class="text-end"><strong>ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¹${inv.total.toFixed(2)}</strong></td>
          <td><small>${escapeHtml(itemsSummary)}${moreItems}</small></td>
          <td class="text-center">
            <button class="btn btn-sm btn-info" onclick="previewSavedInvoice(${index})" title="Preview">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteSavedInvoice(${index})" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      <div class="alert alert-success">
        <strong>Total Invoices:</strong> ${invoices.length}
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Show modal
  new bootstrap.Modal(document.getElementById('viewInvoicesModal')).show();
}

function previewSavedInvoice(index) {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const invoice = invoices[index];
  
  if (!invoice) {
    alert('Invoice not found');
    return;
  }
  
  // Generate and show preview
  const invoiceHTML = generateInvoiceHTML(invoice);
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

function deleteSavedInvoice(index) {
  if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
    return;
  }
  
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const deletedInvoice = invoices[index];
  
  invoices.splice(index, 1);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert(`ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Invoice ${deletedInvoice.invoiceNumber} deleted successfully`);
  
  // Refresh the list
  viewSavedInvoices();
}

// ==========================================
// SHARE INVOICE FEATURE
// ==========================================

// Share Invoice as Image (Primary Method)
async function shareInvoiceAsImage() {
  // Validate customer name
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('Ã¢ÂÅ’ Please enter customer name before sharing');
    return;
  }
  
  showLoading('Generating image...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML in hidden container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    // Wait for fonts to load
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    // Remove temp container
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.customerName.replace(/\s+/g, '_')}.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Try Web Share API (mobile & modern browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoiceData.invoiceNumber}`,
            text: `Invoice for ${invoiceData.customerName} - Ã¢â€šÂ¹${invoiceData.total.toFixed(2)}`,
            files: [file]
          });
          console.log('Ã¢Å“â€¦ Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            fallbackDownloadImage(canvas, fileName);
          }
        }
      } else {
        // Fallback: Download image
        fallbackDownloadImage(canvas, fileName);
      }
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating image:', error);
    alert('Ã¢ÂÅ’ Error generating invoice image. Please try again.');
  }
}

/**
 * ==========================================
 * Ã¢Å“â€¦ NEW: Share Invoice Image on WhatsApp Number
 * ==========================================
 */

// Open WhatsApp number input modal
function shareImageToWhatsAppNumber() {
  // Validate customer name first
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('Ã¢ÂÅ’ Please enter customer name before sharing');
    return;
  }
  
  // Load saved number if exists
  const savedNumber = localStorage.getItem('whatsappNumber');
  if (savedNumber) {
    document.getElementById('whatsappNumberInput').value = savedNumber;
    document.getElementById('saveWhatsAppNumber').checked = true;
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('whatsappNumberModal'));
  modal.show();
  
  // Focus input after modal opens
  setTimeout(() => {
    document.getElementById('whatsappNumberInput').focus();
  }, 500);
}

// Send invoice image to specific WhatsApp number (FINAL FIX - NO STRING ESCAPING ISSUES)
async function sendInvoiceToWhatsApp() {
  const numberInput = document.getElementById('whatsappNumberInput');
  const phoneNumber = numberInput.value.trim();
  
  // Validation
  if (!phoneNumber) {
    alert('âŒ Please enter WhatsApp number');
    numberInput.focus();
    return;
  }
  
  if (!/^[0-9]{10}$/.test(phoneNumber)) {
    alert('âŒ Please enter a valid 10-digit mobile number');
    numberInput.focus();
    return;
  }
  
  // Save number if checkbox checked
  if (document.getElementById('saveWhatsAppNumber').checked) {
    localStorage.setItem('whatsappNumber', phoneNumber);
  }
  
  // Close number input modal
  const numberModal = bootstrap.Modal.getInstance(document.getElementById('whatsappNumberModal'));
  if (numberModal) {
    numberModal.hide();
  }
  
  // Detect iOS
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  // Show loading
  showLoading('Preparing invoice for WhatsApp...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Full phone number with country code
    const fullNumber = '91' + phoneNumber;
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = 'Invoice_' + invoiceData.invoiceNumber + '_' + invoiceData.customerName.replace(/\s+/g, '_') + '.png';
      
      // iOS FIX: Different handling for iPhone
      if (isIOS) {
        // Step 1: Show the image in a new window for user to save manually
        const imageUrl = canvas.toDataURL('image/png');
        const newWindow = window.open('', '_blank');
        
        if (newWindow) {
          // âœ… FINAL FIX: Build HTML using DOM methods (no string escaping needed!)
          const doc = newWindow.document;
          doc.open();
          doc.write('<!DOCTYPE html><html><head>');
          doc.write('<meta name="viewport" content="width=device-width, initial-scale=1">');
          doc.write('<title>Invoice Image</title>');
          
          // Add styles
          const style = doc.createElement('style');
          style.textContent = 
            'body { margin: 0; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif; }' +
            'img { max-width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 20px; }' +
            '.instructions { background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 90%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }' +
            'button { background: #25D366; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 10px; cursor: pointer; }' +
            'ol { text-align: left; line-height: 1.8; }';
          doc.head.appendChild(style);
          doc.write('</head><body>');
          
          // Add instructions
          doc.write('<div class="instructions">');
          doc.write('<h2 style="color: #25D366;">ðŸ“± Save & Share Invoice</h2>');
          doc.write('<ol>');
          doc.write('<li><strong>Tap and hold</strong> on the invoice image below</li>');
          doc.write('<li>Select <strong>"Add to Photos"</strong> or <strong>"Save Image"</strong></li>');
          doc.write('<li>Click the <strong>"Open WhatsApp"</strong> button below</li>');
          doc.write('<li>In WhatsApp, tap <strong>ðŸ“Ž</strong> â†’ <strong>Gallery</strong> â†’ Select invoice â†’ Send</li>');
          doc.write('</ol>');
          doc.write('<button id="waBtn">ðŸ“± Open WhatsApp Chat</button>');
          doc.write('</div>');
          
          // Add image
          doc.write('<img src="' + imageUrl + '" alt="Invoice">');
          
          doc.write('</body></html>');
          doc.close();
          
          // Add WhatsApp button click handler
          const waBtn = doc.getElementById('waBtn');
          if (waBtn) {
            waBtn.onclick = function() {
              const waUrl = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
                encodeURIComponent('Invoice ' + invoiceData.invoiceNumber + ' - â‚¹' + invoiceData.total.toFixed(2));
              newWindow.location.href = waUrl;
            };
          }
          
        } else {
          // Popup blocked - fallback to download
          const link = document.createElement('a');
          link.download = fileName;
          link.href = imageUrl;
          link.click();
          
          // Open WhatsApp after short delay
          setTimeout(function() {
            window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
              encodeURIComponent('Invoice ' + invoiceData.invoiceNumber);
          }, 500);
        }
        
      } else {
        // Android/Desktop: Standard download method
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Show notification
        alert('âœ… Invoice downloaded: ' + fileName + '\n\nðŸ“± WhatsApp will open now. Attach the downloaded invoice from Gallery.');
        
        // Open WhatsApp
        setTimeout(function() {
          const message = encodeURIComponent(
            'ðŸ“„ Invoice ' + invoiceData.invoiceNumber + '\n' +
            'Customer: ' + invoiceData.customerName + '\n' +
            'Amount: â‚¹' + invoiceData.total.toFixed(2)
          );
          window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + message;
        }, 1000);
      }
      
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating invoice image:', error);
    alert('âŒ Error generating invoice image. Please try again.');
  }
}


// Helper: Detect mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Helper: Download invoice image
function downloadInvoiceImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// Fallback: Download image and open WhatsApp
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  downloadInvoiceImage(canvas, fileName);
  
  // Prepare WhatsApp message
  const message = encodeURIComponent(
    `Ã°Å¸â€œâ€ž Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: Ã¢â€šÂ¹${invoiceData.total.toFixed(2)}`
  );
  
  // Open WhatsApp with the specific number
  const whatsappUrl = isMobileDevice() 
    ? `whatsapp://send?phone=${phoneNumber}&text=${message}`
    : `https://wa.me/${phoneNumber}?text=${message}`;
  
  if (isMobileDevice()) {
    // Mobile: Open WhatsApp app directly
    window.location.href = whatsappUrl;
    
    setTimeout(() => {
      alert('Ã°Å¸â€œÂ± Steps to send invoice:\n\n1. Tap attach button (Ã°Å¸â€œÅ½)\n2. Select "Gallery" or "Photos"\n3. Choose the downloaded invoice\n4. Tap Send Ã¢Å“â€œ\n\nThe invoice image is saved in your downloads/gallery.');
    }, 1000);
  } else {
    // Desktop: Open WhatsApp Web
    window.open(whatsappUrl, '_blank');
    alert('Ã¢Å“â€¦ Invoice image downloaded!\nÃ°Å¸â€œÂ± WhatsApp Web opened - please attach the downloaded image and send.');
  }
}


// Fallback: Open WhatsApp Web with message and download image
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  // Open WhatsApp Web with pre-filled message
  const message = encodeURIComponent(
    `Ã°Å¸â€œâ€ž Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: Ã¢â€šÂ¹${invoiceData.total.toFixed(2)}\n\n` +
    `Invoice image downloaded. Please attach and send.`
  );
  
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
  window.open(whatsappUrl, '_blank');
  
  alert('Ã¢Å“â€¦ Invoice image downloaded!\nÃ°Å¸â€œÂ± WhatsApp opened - please attach the downloaded image and send.');
}




    
// Fallback: Download image if share not supported
function fallbackDownloadImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  alert('Ã¢Å“â€¦ Invoice image downloaded! You can now share it from your downloads.');
}

// Generate clean invoice HTML for image conversion
function generateInvoiceHTMLForImage(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${index + 1}</td>
        <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(item.name)}</td>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${item.quantity}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">Ã¢â€šÂ¹${item.rate.toFixed(2)}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">Ã¢â€šÂ¹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:30px;border-bottom:3px solid #0d6efd;padding-bottom:20px;">
        <h1 style="margin:0;font-size:36px;color:#0d6efd;">INVOICE</h1>
        <h2 style="margin:10px 0;font-size:20px;color:#333;">Tile & Sanitaryware Inventory</h2>
      </div>
      
      <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
        <div style="flex:1;">
          <p style="margin:5px 0;"><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
          <p style="margin:5px 0;"><strong>Customer Name:</strong> ${escapeHtml(data.customerName)}</p>
        </div>
        <div style="flex:1;text-align:right;">
          <p style="margin:5px 0;"><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p style="margin:5px 0;"><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:50px;">#</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:left;">Item Description</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:80px;">Quantity</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:100px;">Rate</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <div style="text-align:right;margin-bottom:20px;">
        <table style="margin-left:auto;width:300px;">
          <tr>
            <td style="padding:5px;"><strong>Sub Total:</strong></td>
            <td style="padding:5px;text-align:right;">Ã¢â€šÂ¹${data.subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;color:#dc3545;"><strong>Discount:</strong></td>
            <td style="padding:5px;text-align:right;color:#dc3545;">-Ã¢â€šÂ¹${data.discount.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;"><strong>Tax:</strong></td>
            <td style="padding:5px;text-align:right;">Ã¢â€šÂ¹${data.tax.toFixed(2)}</td>
          </tr>
          <tr style="border-top:2px solid #000;">
            <td style="padding:10px;font-size:18px;"><strong>Grand Total:</strong></td>
            <td style="padding:10px;text-align:right;font-size:18px;"><strong>Ã¢â€šÂ¹${data.total.toFixed(2)}</strong></td>
          </tr>
        </table>
      </div>
      
      ${data.notes ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Customer Notes:</strong></p>
          <p style="margin:5px 0;padding:10px;background:#f8f9fa;border-left:3px solid #0d6efd;">${escapeHtml(data.notes)}</p>
        </div>
      ` : ''}
      
      ${data.terms ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Terms & Conditions:</strong></p>
          <p style="margin:5px 0;white-space:pre-line;font-size:12px;color:#666;">${escapeHtml(data.terms)}</p>
        </div>
      ` : ''}
      
      <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
}

// Share Invoice as PDF
async function shareInvoiceAsPDF() {
  alert('Ã°Å¸â€œâ€ž PDF sharing coming soon! For now, use Preview Ã¢â€ â€™ Print to save as PDF.');
  // You can implement PDF generation using jsPDF or html2pdf.js later
}

// Share via WhatsApp (Text message)
function shareViaWhatsApp() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('Ã¢ÂÅ’ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Share via Email (Text)
function shareViaEmail() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('Ã¢ÂÅ’ Please enter customer name');
    return;
  }
  
  const subject = `Invoice ${invoiceData.invoiceNumber} from Tile & Sanitaryware Inventory`;
  const body = generateShareText(invoiceData);
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoUrl;
}

// Share via SMS (Text)
function shareViaSMS() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('Ã¢ÂÅ’ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
  window.location.href = smsUrl;
}

// Generate text message for sharing
function generateShareText(data) {
  let text = `Ã°Å¸Â§Â¾ INVOICE\n\n`;
  text += `Invoice No: ${data.invoiceNumber}\n`;
  text += `Customer: ${data.customerName}\n`;
  text += `Date: ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}\n`;
  text += `Due Date: ${new Date(data.dueDate).toLocaleDateString('en-IN')}\n\n`;
  
  text += `ITEMS:\n`;
  data.items.forEach((item, i) => {
    text += `${i + 1}. ${item.name} x ${item.quantity} = Ã¢â€šÂ¹${item.amount.toFixed(2)}\n`;
  });
  
  text += `\n`;
  text += `Sub Total: Ã¢â€šÂ¹${data.subtotal.toFixed(2)}\n`;
  if (data.discount > 0) {
    text += `Discount: -Ã¢â€šÂ¹${data.discount.toFixed(2)}\n`;
  }
  if (data.tax > 0) {
    text += `Tax: Ã¢â€šÂ¹${data.tax.toFixed(2)}\n`;
  }
  text += `Ã¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€ÂÃ¢â€Â\n`;
  text += `TOTAL: Ã¢â€šÂ¹${data.total.toFixed(2)}\n\n`;
  
  text += `Thank you for your business!\n`;
  text += `- Tile & Sanitaryware Inventory`;
  
  return text;
}

// Show loading indicator
function showLoading(message = 'Loading...') {
  // Check if loading div already exists
  let loadingDiv = document.getElementById('globalLoading');
  
  if (!loadingDiv) {
    // Create loading indicator
    loadingDiv = document.createElement('div');
    loadingDiv.id = 'globalLoading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;
    
    loadingDiv.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div style="margin-top: 15px; color: #333;" id="loadingMessage">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loadingDiv);
  } else {
    // Update message
    const messageEl = document.getElementById('loadingMessage');
    if (messageEl) {
      messageEl.textContent = message;
    }
    loadingDiv.style.display = 'flex';
  }
}

// Hide loading indicator
function hideLoading() {
  const loadingDiv = document.getElementById('globalLoading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
}


/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Toggle Sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  }
}

// Close Sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// âœ… UPDATE: Go to Home function
function goToHome() {
  closeSidebar();
  navigateToHome();
}

// âœ… UPDATE: Sidebar Action function
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  alert('â³ "' + action.replace(/([A-Z])/g, ' $1').trim() + '" feature coming soon!\n\nThis will be implemented in the next phase.');
  
  closeSidebar();
}


// Navigate to All Products page - FIXED
function navigateToAllProducts() {
  console.log('ðŸ“¦ Navigating to All Products');
  
  currentPage = 'allProducts';
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // âœ… HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW All Products page
  if (allProductsPage) {
    allProductsPage.classList.add('active');
  }
  
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  
  if (typeof renderAllProductsList === 'function') {
    renderAllProductsList();
  }
  
  closeSidebar();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Navigate to Product Groups page - FIXED
function navigateToProductGroups() {
  console.log('ðŸ“ Navigating to Product Groups');
  
  currentPage = 'productGroups';
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // âœ… HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Product Groups page
  if (productGroupsPage) {
    productGroupsPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  
  if (typeof syncProductGroups === 'function') {
    syncProductGroups();
  }
  
  closeSidebar();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Navigate back to Home - FIXED
function navigateToHome() {
  console.log('ðŸ  Navigating to Home');
  
  currentPage = 'home';
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  if (mainApp) {
    mainApp.style.display = 'block';
  }
  
  // âœ… SHOW THE BLUE NAVBAR AGAIN
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'block';
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  
  closeSidebar();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  const btnPhotoView = document.getElementById('btnPhotoView');
  if (btnPhotoView && btnPhotoView.classList.contains('active')) {
    if (typeof showAllProducts === 'function') {
      showAllProducts();
    }
  }
}

// Navigate to Group Detail - FIXED
function navigateToGroupDetail(groupId, groupName) {
  console.log('ðŸ“¦ Navigating to Group Detail:', groupName);
  
  currentPage = 'groupDetail';
  currentGroupId = groupId;
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // âœ… HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Group Detail page
  if (groupDetailPage) {
    groupDetailPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  
  // Set group title
  const groupTitleEl = document.getElementById('groupDetailTitle');
  if (groupTitleEl) {
    groupTitleEl.textContent = groupName;
  }
  
  // Load variants
  if (typeof syncGroupVariants === 'function') {
    syncGroupVariants(groupId);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



// Navigate to Product Groups page
function navigateToProductGroups() {
  currentPage = 'productGroups';
  
  // Show Product Groups page, hide others
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // âœ… NULL CHECKS
  if (mainApp) mainApp.style.display = 'none';
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.add('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  
  // Load and render product groups
  syncProductGroups();
  
  // Close sidebar
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



// Open Add Product modal (from All Products page) - FIXED
function openAddProduct() {
  console.log('ðŸ“ Opening Add Product modal');
  
  // Reset product modal
  const modalTitle = document.getElementById('modalTitle');
  const productForm = document.getElementById('productForm');
  const productId = document.getElementById('productId');
  const currentPhotoUrl = document.getElementById('currentPhotoUrl');
  const photoPreview = document.getElementById('photoPreview');
  
  if (modalTitle) modalTitle.textContent = 'Add New Product';
  if (productForm) productForm.reset();
  if (productId) productId.value = '';
  if (currentPhotoUrl) currentPhotoUrl.value = '';
  if (photoPreview) photoPreview.style.display = 'none';
  
  // Show modal - FIXED Bootstrap 5 syntax
  const productModal = document.getElementById('productModal');
  if (productModal) {
    const modal = new bootstrap.Modal(productModal);
    modal.show();
    console.log('âœ… Product modal opened');
  } else {
    console.error('âŒ Product modal not found');
    alert('Error: Product modal not found. Please refresh the page.');
  }
}

/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */

// Render All Products List - UPDATED
function renderAllProductsList() {
  const container = document.getElementById('allProductsList');
  
  if (!container) {
    console.error('âŒ allProductsList container not found');
    return;
  }
  
  if (!cachedProducts || cachedProducts.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px; color:#999;">
        <i class="bi bi-box-seam" style="font-size:64px;"></i>
        <h4 style="margin-top:20px;">No Products Yet</h4>
        <p>Add your first product to get started</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  cachedProducts.forEach(product => {
    const stockBadge = product.stock <= product.minStock 
      ? `<span style="color:#dc3545;">âš ï¸ Low (${product.stock})</span>`
      : `<span style="color:#28a745;">âœ“ ${product.stock}</span>`;
    
    const productIcon = getProductIcon(product.category);
    
    // âœ… REMOVED EYE BUTTON, MADE CARD CLICKABLE
    html += `
      <div class="product-item-compact" onclick="showProductDetails('${product.id}')" style="cursor: pointer;">
        <div class="product-item-icon">${productIcon}</div>
        <div class="product-item-info">
          <div class="product-item-name">${product.name}</div>
          <div class="product-item-details">
            <span><i class="bi bi-tag"></i> ${product.category}</span>
            ${product.brand ? `<span><i class="bi bi-award"></i> ${product.brand}</span>` : ''}
            ${product.size ? `<span><i class="bi bi-rulers"></i> ${product.size}</span>` : ''}
            <span>${stockBadge}</span>
            <span><i class="bi bi-currency-rupee"></i>${product.price.toFixed(2)}</span>
          </div>
        </div>
        <div class="product-item-actions" onclick="event.stopPropagation()">
          <button class="btn-edit-compact" onclick="editProduct('${product.id}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-delete-compact" onclick="confirmDeleteProduct('${product.id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Show Product Details (when card is clicked) - NEW FUNCTION
function showProductDetails(productId) {
  console.log('ðŸ‘ï¸ Showing details for product:', productId);
  
  // Find the product
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    console.error('Product not found:', productId);
    return;
  }
  
  // Create modal content
  const modalContent = `
    <div style="padding: 20px;">
      ${product.imageUrl ? `<img src="${product.imageUrl}" style="width:100%; max-height:300px; object-fit:cover; border-radius:8px; margin-bottom:20px;" />` : ''}
      <h3 style="margin-bottom: 20px;">${product.name}</h3>
      <table style="width:100%; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Category:</td>
          <td style="padding: 10px;">${product.category}</td>
        </tr>
        ${product.brand ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Brand:</td>
          <td style="padding: 10px;">${product.brand}</td>
        </tr>` : ''}
        ${product.size ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Size:</td>
          <td style="padding: 10px;">${product.size}</td>
        </tr>` : ''}
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Unit Type:</td>
          <td style="padding: 10px;">${product.unitType || 'Piece'}</td>
        </tr>
        ${product.piecesPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Pieces/Box:</td>
          <td style="padding: 10px;">${product.piecesPerBox}</td>
        </tr>` : ''}
        ${product.sftPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">SFT/Box:</td>
          <td style="padding: 10px;">${product.sftPerBox}</td>
        </tr>` : ''}
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Price:</td>
          <td style="padding: 10px; font-size: 18px; color: #007bff; font-weight: 600;">â‚¹${product.price.toFixed(2)}</td>
        </tr>
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Stock:</td>
          <td style="padding: 10px;">
            <span style="color: ${product.stock <= product.minStock ? '#dc3545' : '#28a745'}; font-weight: 600;">
              ${product.stock} ${product.unitType || 'pieces'}
            </span>
          </td>
        </tr>
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Min Stock Alert:</td>
          <td style="padding: 10px;">${product.minStock}</td>
        </tr>
      </table>
    </div>
  `;
  
  // Show in a Bootstrap modal (reuse existing modal or create new one)
  const modalEl = document.getElementById('productDetailModal');
  if (modalEl) {
    document.getElementById('productDetailModalBody').innerHTML = modalContent;
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  } else {
    // Fallback: show as alert if modal doesn't exist
    alert(`Product: ${product.name}\nPrice: â‚¹${product.price}\nStock: ${product.stock}\nCategory: ${product.category}`);
  }
}

// Confirm delete with better UX
function confirmDeleteProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  const productName = product ? product.name : 'this product';
  
  if (confirm(`âš ï¸ Delete "${productName}"?\n\nThis action cannot be undone.`)) {
    deleteProduct(productId);
  }
}


// Render Product Groups List
function renderProductGroupsList() {
  const container = document.getElementById('productGroupsList');
  const emptyState = document.getElementById('groupsEmptyState');
  
  if (cachedProductGroups.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  let html = '';
  
  cachedProductGroups.forEach(group => {
    html += `
      <div class="group-card" onclick="navigateToGroupDetail('${group.groupId}', '${escapeHtml(group.groupName)}')">
        <div class="group-card-header">
          <div class="group-card-icon">
            <i class="bi bi-collection"></i>
          </div>
          <div class="group-card-title">
            <h4>${escapeHtml(group.groupName)}</h4>
            <p>${group.totalVariants} variant${group.totalVariants !== 1 ? 's' : ''}</p>
          </div>
        </div>
        ${group.description ? `<p style="color:#666; font-size:13px; margin:0;">${escapeHtml(group.description)}</p>` : ''}
        <div class="group-card-actions" onclick="event.stopPropagation()">
          <button class="btn btn-primary" onclick="navigateToGroupDetail('${group.groupId}', '${escapeHtml(group.groupName)}')">
            <i class="bi bi-eye"></i> View
          </button>
          <button class="btn btn-danger" onclick="confirmDeleteGroup('${group.groupId}', '${escapeHtml(group.groupName)}')">
            <i class="bi bi-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Render Group Variants List
function renderGroupVariantsList(variants) {
  const container = document.getElementById('groupVariantsList');
  
  if (variants.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px; color:#999;">
        <i class="bi bi-box" style="font-size:64px;"></i>
        <h4 style="margin-top:20px;">No Variants</h4>
        <p>This group has no variants yet</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  variants.forEach(variant => {
    const stockBadge = variant.stock <= variant.minStock 
      ? `<span style="color:#dc3545;">âš ï¸ Low (${variant.stock})</span>`
      : `<span style="color:#28a745;">âœ“ ${variant.stock}</span>`;
    
    // Build attributes display
    let attributesHtml = '';
    if (variant.attributes) {
      Object.keys(variant.attributes).forEach(key => {
        attributesHtml += `<span><strong>${key}:</strong> ${variant.attributes[key]}</span> `;
      });
    }
    
    html += `
      <div class="product-item-compact">
        <div class="product-item-icon">ðŸ“¦</div>
        <div class="product-item-info">
          <div class="product-item-name">${escapeHtml(variant.variantName)}</div>
          <div class="product-item-details">
            ${attributesHtml}
            <span>${stockBadge}</span>
            <span><i class="bi bi-currency-rupee"></i>${variant.price.toFixed(2)}</span>
          </div>
        </div>
        <div class="product-item-actions">
          <button class="btn-edit-compact" onclick="editVariant('${variant.variantId}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-delete-compact" onclick="confirmDeleteVariant('${variant.variantId}', '${escapeHtml(variant.variantName)}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Get product icon based on category
function getProductIcon(category) {
  const icons = {
    'Tiles': 'ðŸ”²',
    'Sanitaryware': 'ðŸš¿',
    'Accessories': 'ðŸ”§',
    'Custom': 'ðŸ“¦',
    'Photo Products': 'ðŸ“¸'
  };
  return icons[category] || 'ðŸ“¦';
}
/**
 * ==========================================
 * FILTER & SEARCH FUNCTIONS
 * ==========================================
 */

// Filter All Products by search
function filterAllProducts() {
  const searchText = document.getElementById('allProductsSearch').value.toLowerCase();
  
  const filteredProducts = cachedProducts.filter(product => {
    return product.name.toLowerCase().includes(searchText) ||
           product.category.toLowerCase().includes(searchText) ||
           (product.brand && product.brand.toLowerCase().includes(searchText)) ||
           (product.size && product.size.toLowerCase().includes(searchText));
  });
  
  // Temporarily update cachedProducts for rendering
  const originalProducts = cachedProducts;
  cachedProducts = filteredProducts;
  renderAllProductsList();
  cachedProducts = originalProducts;
}

// Filter by category
let currentCategoryFilter = 'all';

function filterByCategory(category) {
  currentCategoryFilter = category;
  
  // Update button states
  const buttons = document.querySelectorAll('#allProductsPage .btn-outline-primary');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  if (category === 'all') {
    renderAllProductsList();
    return;
  }
  
  const filteredProducts = cachedProducts.filter(p => p.category === category);
  
  // Temporarily update for rendering
  const originalProducts = cachedProducts;
  cachedProducts = filteredProducts;
  renderAllProductsList();
  cachedProducts = originalProducts;
}

// Filter Group Variants by search
function filterGroupVariants() {
  const searchText = document.getElementById('groupVariantsSearch').value.toLowerCase();
  
  if (!currentGroupId) return;
  
  // Get variants for current group
  const allVariants = cachedGroupVariants[currentGroupId] || [];
  
  const filteredVariants = allVariants.filter(variant => {
    return variant.variantName.toLowerCase().includes(searchText);
  });
  
  renderGroupVariantsList(filteredVariants);
}
/**
 * ==========================================
 * DATA SYNC FUNCTIONS (PRODUCT GROUPS)
 * ==========================================
 */

// Sync Product Groups from server
async function syncProductGroups() {
  // âœ… Check if SCRIPT_URL is defined
  if (typeof SCRIPT_URL === 'undefined' || !SCRIPT_URL) {
    console.error('âŒ SCRIPT_URL is not defined');
    const groupsListEl = document.getElementById('productGroupsList');
    const emptyStateEl = document.getElementById('groupsEmptyState');
    if (groupsListEl) groupsListEl.innerHTML = '';
    if (emptyStateEl) emptyStateEl.style.display = 'block';
    return;
  }
  
  try {
    showLoading('Loading product groups...');
    
    const params = new URLSearchParams({
      action: 'getProductGroups',
      email: localStorage.getItem('userEmail') || '',
      hash: localStorage.getItem('userHash') || ''
    });
    
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = await response.json();
    
    hideLoading();
    
    if (data.ok && data.groups) {
      cachedProductGroups = data.groups;
      renderProductGroupsList();
      
      // Update dashboard counter
      if (typeof updateSummaryFromCache === 'function') {
        updateSummaryFromCache();
      }
    } else {
      console.error('Failed to load product groups:', data.error);
      // Show empty state instead of error
      renderProductGroupsList();
    }
    
  } catch (error) {
    hideLoading();
    console.error('Error syncing product groups:', error);
    // Show empty state
    renderProductGroupsList();
  }
}


// Sync variants for specific group
async function syncGroupVariants(groupId) {
  try {
    showLoading('Loading variants...');
    
    const params = new URLSearchParams({
      action: 'getGroupVariants',
      groupId: groupId,
      email: localStorage.getItem('userEmail') || '',
      hash: localStorage.getItem('userHash') || ''
    });
    
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = await response.json();
    
    hideLoading();
    
    if (data.ok && data.variants) {
      // Cache variants for this group
      cachedGroupVariants[groupId] = data.variants;
      renderGroupVariantsList(data.variants);
    } else {
      console.error('Failed to load variants:', data.error);
      showError('Failed to load variants');
    }
    
  } catch (error) {
    hideLoading();
    console.error('Error syncing variants:', error);
    showError('Error loading variants');
  }
}

// Sync all variants (for dashboard counter)
async function syncAllVariants() {
  try {
    const params = new URLSearchParams({
      action: 'getAllVariants',
      email: localStorage.getItem('userEmail') || '',
      hash: localStorage.getItem('userHash') || ''
    });
    
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = await response.json();
    
    if (data.ok && data.variants) {
      // Update "Products in Group" counter
      const totalVariants = data.variants.length;
      const counter = document.getElementById('productsInGroup');
      if (counter) {
        counter.textContent = totalVariants;
      }
    }
    
  } catch (error) {
    console.error('Error syncing all variants:', error);
  }
}
/**
 * ==========================================
 * DELETE CONFIRMATION FUNCTIONS
 * ==========================================
 */

// Confirm delete product group
function confirmDeleteGroup(groupId, groupName) {
  if (confirm(`âš ï¸ Delete group "${groupName}"?\n\nThis will delete the group and all ${cachedProductGroups.find(g => g.groupId === groupId)?.totalVariants || 0} variants.\n\nThis action cannot be undone.`)) {
    deleteProductGroup(groupId);
  }
}

// Delete product group
async function deleteProductGroup(groupId) {
  try {
    showLoading('Deleting group...');
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'deleteProductGroup',
        email: localStorage.getItem('userEmail') || '',
        hash: localStorage.getItem('userHash') || '',
        data: JSON.stringify({ groupId: groupId })
      })
    });
    
    const data = await response.json();
    
    hideLoading();
    
    if (data.ok) {
      showSuccess('âœ… Group deleted successfully');
      
      // Remove from cache
      cachedProductGroups = cachedProductGroups.filter(g => g.groupId !== groupId);
      delete cachedGroupVariants[groupId];
      
      // Re-render
      renderProductGroupsList();
      updateDashboard();
    } else {
      showError('Failed to delete group: ' + (data.error || 'Unknown error'));
    }
    
  } catch (error) {
    hideLoading();
    console.error('Error deleting group:', error);
    showError('Error deleting group');
  }
}

// Confirm delete variant
function confirmDeleteVariant(variantId, variantName) {
  if (confirm(`âš ï¸ Delete variant "${variantName}"?\n\nThis action cannot be undone.`)) {
    deleteGroupVariant(variantId);
  }
}

// Delete variant
async function deleteGroupVariant(variantId) {
  try {
    showLoading('Deleting variant...');
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'deleteGroupVariant',
        email: localStorage.getItem('userEmail') || '',
        hash: localStorage.getItem('userHash') || '',
        data: JSON.stringify({ variantId: variantId })
      })
    });
    
    const data = await response.json();
    
    hideLoading();
    
    if (data.ok) {
      showSuccess('âœ… Variant deleted successfully');
      
      // Reload variants for current group
      if (currentGroupId) {
        syncGroupVariants(currentGroupId);
      }
      
      // Update dashboard
      updateDashboard();
    } else {
      showError('Failed to delete variant: ' + (data.error || 'Unknown error'));
    }
    
  } catch (error) {
    hideLoading();
    console.error('Error deleting variant:', error);
    showError('Error deleting variant');
  }
}
/**
 * ==========================================
 * PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
 * ==========================================
 */

// View product details (placeholder)
function viewProductDetails(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    showError('Product not found');
    return;
  }
  
  // Simple alert for now - can be replaced with modal later
  let details = `ðŸ“¦ ${product.name}\n\n`;
  details += `Category: ${product.category}\n`;
  if (product.brand) details += `Brand: ${product.brand}\n`;
  if (product.size) details += `Size: ${product.size}\n`;
  details += `Price: â‚¹${product.price.toFixed(2)} / ${product.unitType}\n`;
  details += `Stock: ${product.stock}\n`;
  details += `Min Stock: ${product.minStock}\n`;
  
  alert(details);
}

// Edit variant (placeholder)
function editVariant(variantId) {
  alert('â³ Edit variant feature coming soon!\n\nFor now, you can:\nâ€¢ Delete the variant\nâ€¢ Create a new one with correct details');
}

// Open Create Group Modal (placeholder - will implement in Part 4)
function openCreateGroupModal() {
  alert('â³ Create Product Group feature coming soon!\n\nThis will allow you to:\nâ€¢ Create groups like "T-Shirts"\nâ€¢ Add attributes (Size, Color, etc.)\nâ€¢ Auto-generate all variant combinations');
}
/**
 * ==========================================
 * UTILITY FUNCTIONS
 * ==========================================
 */

// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Show success message
function showSuccess(message) {
  alert('âœ… ' + message);
}

// Show error message
function showError(message) {
  alert('âŒ ' + message);
}


    

    
  </script>






    
    </script>

  <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Change Password Modal -->
  <div id="changePasswordModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-key me-2"></i>Change Password
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Step 1: Verify Current Password -->
          <div id="verifyPasswordStep">
            <p class="text-muted">Enter your current password to continue</p>
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input 
                type="password" 
                id="currentPasswordInput" 
                class="form-control" 
                placeholder="Enter current password"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="verifyCurrentPassword()">
                Continue
              </button>
            </div>
          </div>
          
          <!-- Step 2: Enter New Password -->
          <div id="newPasswordStep" style="display: none;">
            <p class="text-muted">Choose a new password (minimum 6 characters)</p>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input 
                type="password" 
                id="newPasswordInput" 
                class="form-control" 
                placeholder="Enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input 
                type="password" 
                id="confirmPasswordInput" 
                class="form-control" 
                placeholder="Re-enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-success" onclick="submitNewPassword()">
                <i class="bi bi-check-circle me-2"></i>Change Password
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Ã¢Å“â€¦ NEW: WhatsApp Number Input Modal -->
<div class="modal fade" id="whatsappNumberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-whatsapp"></i> Share Invoice on WhatsApp
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Enter the recipient's WhatsApp number (with country code)
        </div>
        
        <div class="mb-3">
          <label class="form-label">WhatsApp Number</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input type="tel" 
                   class="form-control" 
                   id="whatsappNumberInput" 
                   placeholder="9876543210" 
                   maxlength="10"
                   pattern="[0-9]{10}"
                   required>
          </div>
          <small class="text-muted">Enter 10-digit mobile number (without +91)</small>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="saveWhatsAppNumber">
          <label class="form-check-label" for="saveWhatsAppNumber">
            Remember this number for next time
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="sendInvoiceToWhatsApp()">
          <i class="bi bi-whatsapp"></i> Send to WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Product Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="productDetailModalBody">
        <!-- Content will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



    
</body>
</html>

</body>
</html>
















































































